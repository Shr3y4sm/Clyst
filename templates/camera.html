<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clyst | Camera & Location</title>
  <script src="https://cdn.jsdelivr.net/npm/piexifjs"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../static/css/styles.css"></link>
  <link rel="stylesheet" href="../static/css/camera.css"></link>
</head>
<body>
  <!-- ===== NAVBAR ===== -->
    <nav id="topNav">
      <div class="nav">
              <div class="nav-left">
        <div class="hamburger" onclick="toggleMenu(event)">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4H21V6H3V4ZM3 11H21V13H3V11ZM3 18H21V20H3V18Z"></path></svg>
        </div>
        <a href="{{ url_for('home') }}">Clyst</a>
      </div>

      <div class="nav-center" id="navLinks">
        <a href="{{ url_for('home') }}">Community Feed</a>
        <a href="{{ url_for('products_page') }}">Marketplace</a>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
        <a href="{{ url_for('login') }}">Login</a>
        <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
      </div>

      <div class="nav-actions">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('profile') }}" class="profile-btn" title="Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"
            />
          </svg>
        </a>
        {% endif %}
      </div>
      </div>
    <div class="mobile-menu" id="mobileMenu">
      <a href="{{ url_for('home') }}">Community Feed</a>
      <a href="{{ url_for('products_page') }}">Marketplace</a>
      {% if current_user.is_authenticated %}
      <a href="{{ url_for('logout') }}">Logout</a>
      {% else %}
      <a href="{{ url_for('login') }}">Login</a>
      <a href="{{ url_for('register') }}">Register</a>
      {% endif %}
    </div>
    </nav>

  <main>
    <div class="card">
      <h2>Capture Photo & Location</h2>
      <div class="camera-section">
      <video id="camera" playsinline muted></video>
      <button id="capture" class="capture">
        <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" fill="#e4b4c7" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm72-88a72,72,0,1,1-72-72A72.08,72.08,0,0,1,200,128Z"></path></svg>
      </button>
    </div>
      <canvas id="canvas" style="display:none;"></canvas>
      <div class="camera-img">
      <img id="photo" style="display:none;">
      <div class="actions-btn">
      <button id="submit" class="btn" style="display:none;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M3 12.9999H9V10.9999H3V1.84558C3 1.56944 3.22386 1.34558 3.5 1.34558C3.58425 1.34558 3.66714 1.36687 3.74096 1.40747L22.2034 11.5618C22.4454 11.6949 22.5337 11.9989 22.4006 12.2409C22.3549 12.324 22.2865 12.3924 22.2034 12.4381L3.74096 22.5924C3.499 22.7255 3.19497 22.6372 3.06189 22.3953C3.02129 22.3214 3 22.2386 3 22.1543V12.9999Z"></path>
        </svg></button>
      <button id="retake" class="btn" style="display:none;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6 4H21C21.5523 4 22 4.44772 22 5V12H20V6H6V9L1 5L6 1V4ZM18 20H3C2.44772 20 2 19.5523 2 19V12H4V18H18V15L23 19L18 23V20Z"></path>
        </svg></button>
      </div></div>
      <div class="info" id="location-info"></div>
    </div>
  </main>

  <footer>© 2025 Clyst — Empowering Local Artisans</footer>

  <script>
    const video=document.getElementById('camera');
    const canvas=document.getElementById('canvas');
    const photo=document.getElementById('photo');
    const info=document.getElementById('location-info');
    const captureBtn=document.getElementById('capture');
    const submitBtn=document.getElementById('submit');
    const retakeBtn=document.getElementById('retake');
    
    let currentStream = null;

    async function initCamera(){
      try{
        const stream=await navigator.mediaDevices.getUserMedia({
          video:{facingMode:'environment'}
        });
        currentStream = stream;
        video.srcObject=stream;
        await video.play();
      }catch(err){
        alert("Camera access error: "+err.message);
      }
    }
    
    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
    }
    
    function showCaptureView() {
      video.style.display = 'block';
      captureBtn.style.display = 'flex';
      photo.style.display = 'none';
      submitBtn.style.display = 'none';
      retakeBtn.style.display = 'none';
      info.innerHTML = '';
    }
    
    function showResultView() {
      video.style.display = 'none';
      captureBtn.style.display = 'none';
      photo.style.display = 'block';
      submitBtn.style.display = 'flex';
      retakeBtn.style.display = 'flex';
    }
    
    initCamera();

    captureBtn.addEventListener('click',async()=>{
      if(!video.videoWidth){
        alert("Camera not ready. Try again.");
        return;
      }
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
      const ctx=canvas.getContext('2d');
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const imageData=canvas.toDataURL('image/jpeg');

      // Stop the camera immediately after capture
      stopCamera();

      info.innerHTML="<em>Fetching location...</em>";
      navigator.geolocation.getCurrentPosition(async pos=>{
        const {latitude,longitude}=pos.coords;
        const address=await getAddress(latitude,longitude);
        info.innerHTML=`
          <b>Latitude:</b></br><p>${latitude.toFixed(5)}</p></br>
          <b>Longitude:</b></br><p>${longitude.toFixed(5)}</p></br>
          <b>Address:</b></br><p>${address}</p>
        `;
        try{
          const newImg=addExifData(imageData,latitude,longitude);
          photo.src=newImg;
        }catch(e){
          photo.src=imageData; // fallback if piexif fails
        }
        showResultView();
      },err=>{
        alert("Location denied: "+err.message);
        photo.src=imageData;
        showResultView();
      });
    });
    
    submitBtn.addEventListener('click', async () => {
      const imageData = photo.src;
      const locationInfo = info.innerHTML;
      
      try {
        const response = await fetch('/complete-verification', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            photo: imageData,
            location_data: locationInfo
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            window.location.href = result.redirect;
          } else {
            alert("Verification failed: " + result.message);
          }
        } else {
          alert("Error submitting verification data");
        }
      } catch (error) {
        alert("Error: " + error.message);
      }
    });
    
    retakeBtn.addEventListener('click', () => {
      showCaptureView();
      initCamera();
    });

    function toDMS(deg){
      const d=Math.floor(deg);
      const minfloat=(deg-d)*60;
      const m=Math.floor(minfloat);
      const secfloat=(minfloat-m)*60;
      const s=Math.round(secfloat*100);
      return [[d,1],[m,1],[s,100]];
    }

    function addExifData(imageData,lat,lon){
      const gps={
        [piexif.GPSIFD.GPSLatitudeRef]:lat>=0?"N":"S",
        [piexif.GPSIFD.GPSLatitude]:toDMS(Math.abs(lat)),
        [piexif.GPSIFD.GPSLongitudeRef]:lon>=0?"E":"W",
        [piexif.GPSIFD.GPSLongitude]:toDMS(Math.abs(lon))
      };
      const exifObj={GPS:gps};
      const exifBytes=piexif.dump(exifObj);
      return piexif.insert(exifBytes,imageData);
    }

    async function getAddress(lat,lon){
      try{
        const url=`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`;
        const res=await fetch(url,{headers:{'User-Agent':'ClystCamera/1.0'}});
        const data=await res.json();
        return data.display_name||"Address not found";
      }catch{return"Error fetching address";}
    }
  </script>
</body>
</html>
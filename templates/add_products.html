<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clyst - Add Product</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../static/css/styles.css" />
    <link rel="stylesheet" href="../static/css/add.css" />
    <style>
      .voice-input-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
        align-items: center;
      }
      .voice-language-select {
        flex: 1;
        padding: 10px 14px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        background: #f8f9fa;
        color: #333;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .voice-language-select:hover {
        border-color: #4CAF50;
        background: white;
      }
      .voice-language-select:focus {
        outline: none;
        border-color: #4CAF50;
        background: white;
      }
      .voice-input-btn {
        padding: 10px 18px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.3s ease;
        font-weight: 500;
        white-space: nowrap;
      }
      .voice-input-btn:hover {
        background: #45a049;
        transform: scale(1.02);
      }
      .voice-input-btn.recording {
        background: #f44336;
        animation: pulse 1.5s ease-in-out infinite;
      }
      .voice-input-btn.recording::after {
        content: " Recording...";
        font-size: 13px;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      .voice-status {
        font-size: 13px;
        color: #4CAF50;
        margin-top: 6px;
        padding: 8px 12px;
        background: #e8f5e9;
        border-radius: 6px;
        font-style: italic;
        border-left: 3px solid #4CAF50;
      }
    </style>
  </head>
  <body>
    <!-- ===== NAVBAR ===== -->
    <nav id="topNav">
      <div class="nav">
        <div class="nav-left">
          <div class="hamburger" onclick="toggleMenu(event)">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path d="M3 4H21V6H3V4ZM3 11H21V13H3V11ZM3 18H21V20H3V18Z"></path>
            </svg>
          </div>
          <a href="{{ url_for('home') }}">Clyst</a>
        </div>

        <div class="nav-center" id="navLinks">
          <a href="{{ url_for('home') }}">Community Feed</a>
          <a href="{{ url_for('products_page') }}">Marketplace</a>
          {% if current_user.is_authenticated %}
          <a href="{{ url_for('logout') }}">Logout</a>
          {% else %}
          <a href="{{ url_for('login') }}">Login</a>
          <a href="{{ url_for('register') }}">Register</a>
          {% endif %}
        </div>

        <div class="nav-actions">
          {% if current_user.is_authenticated %}
          <a
            href="{{ url_for('profile') }}"
            class="profile-btn"
            title="Profile"
          >
           <svg width="100%" height="100%" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M28.8662 27.5C28.7784 27.652 28.6521 27.7783 28.5001 27.8661C28.348 27.9538 28.1755 28 28 28H3.99995C3.8245 27.9998 3.65219 27.9535 3.50031 27.8656C3.34843 27.7778 3.22234 27.6515 3.13469 27.4995C3.04705 27.3475 3.00093 27.1752 3.00098 26.9997C3.00102 26.8243 3.04723 26.6519 3.13495 26.5C5.0387 23.2087 7.97245 20.8487 11.3962 19.73C9.70266 18.7218 8.38688 17.1856 7.65094 15.3572C6.91499 13.5289 6.79956 11.5095 7.32238 9.60918C7.8452 7.70887 8.97735 6.03272 10.545 4.83814C12.1126 3.64355 14.029 2.99658 16 2.99658C17.9709 2.99658 19.8873 3.64355 21.4549 4.83814C23.0226 6.03272 24.1547 7.70887 24.6775 9.60918C25.2003 11.5095 25.0849 13.5289 24.349 15.3572C23.613 17.1856 22.2972 18.7218 20.6037 19.73C24.0275 20.8487 26.9612 23.2087 28.865 26.5C28.9529 26.6519 28.9993 26.8243 28.9996 26.9998C28.9998 27.1754 28.9538 27.3479 28.8662 27.5Z" fill="inherit"/></svg>
        
          </a>
          {% endif %}
        </div>
      </div>
      <div class="mobile-menu" id="mobileMenu">
        <a href="{{ url_for('home') }}">Community Feed</a>
        <a href="{{ url_for('products_page') }}">Marketplace</a>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
        <a href="{{ url_for('login') }}">Login</a>
        <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
      </div>
    </nav>

    <div class="container">
      <!-- Main Content -->
      <div class="main-content">
        <div class="form-container">
          <div class="form-card">
            <div class="form-header">
              <h1>
                {% if product %}Edit Product{% else %}Add New Product{% endif %}
              </h1>
              <p>
                {% if product %}Update your artwork in the marketplace{% else
                %}Sell your artwork in the marketplace{% endif %}
              </p>
            </div>
            <form
              action="{{ url_for('add_products', product_id=product.product_id if product else None) }}"
              method="POST"
              enctype="multipart/form-data"
            >
              <div class="form-group">
                <label for="product_name" class="form-label">
                  Product Name
                </label>
                <input
                  type="text"
                  id="product_name"
                  name="product_name"
                  class="form-input"
                  placeholder="Enter the name of your artwork..."
                  value="{{ product.title if product else '' }}"
                  required
                />
                <div class="form-help">
                  Choose a descriptive name for your product
                </div>
              </div>
              
              <div class="price-translate-group">
              <div class="form-group">
                <label for="price" class="form-label"> Price (Rs.) </label>
                <input
                  type="number"
                  id="price"
                  name="price"
                  class="form-input"
                  step="0.01"
                  min="0"
                  placeholder="0.00"
                  value="{{ product.price if product else '' }}"
                  required
                />
                <div class="form-help">Set a fair price for your artwork</div>
              </div>
                  <div class="form-group">
                    <label class="form-label">Translate title & description</label>
                    <div class="translate-form" style="display:flex; align-items:center;">
                      <select id="tr_lang" class="form-input">
                        <option value="">Select language</option>
                        <option value="en">English (en)</option>
                        <option value="hi">Hindi (hi)</option>
                        <option value="bn">Bengali (bn)</option>
                        <option value="ta">Tamil (ta)</option>
                        <option value="te">Telugu (te)</option>
                        <option value="mr">Marathi (mr)</option>
                        <option value="gu">Gujarati (gu)</option>
                        <option value="kn">Kannada (kn)</option>
                        <option value="ml">Malayalam (ml)</option>
                        <option value="pa">Punjabi (pa)</option>
                        <option value="ur">Urdu (ur)</option>
                        <option value="es">Spanish (es)</option>
                        <option value="fr">French (fr)</option>
                        <option value="de">German (de)</option>
                        <option value="zh">Chinese (zh)</option>
                        <option value="ja">Japanese (ja)</option>
                      </select>
                      <button type="button" id="do_translate" class="btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.7134 8.12811L19.4668 8.69379C19.2864 9.10792 18.7136 9.10792 18.5331 8.69379L18.2866 8.12811C17.8471 7.11947 17.0555 6.31641 16.0677 5.87708L15.308 5.53922C14.8973 5.35653 14.8973 4.75881 15.308 4.57612L16.0252 4.25714C17.0384 3.80651 17.8442 2.97373 18.2761 1.93083L18.5293 1.31953C18.7058 0.893489 19.2942 0.893489 19.4706 1.31953L19.7238 1.93083C20.1558 2.97373 20.9616 3.80651 21.9748 4.25714L22.6919 4.57612C23.1027 4.75881 23.1027 5.35653 22.6919 5.53922L21.9323 5.87708C20.9445 6.31641 20.1529 7.11947 19.7134 8.12811ZM22.9 21L18.5 10H16.5L12.101 21H14.255L15.454 18H19.544L20.745 21H22.9ZM16.253 16L17.5 12.8852L18.745 16H16.253ZM7.5466 12.3036C6.41407 11.0171 5.45992 9.56967 4.72266 8H6.96329C7.53108 9.04434 8.21011 10.0196 8.98442 10.9097C10.2737 9.48824 11.3027 7.82653 11.9961 6H2V4H8V2H10V4H14.6497C14.5624 4.42994 14.4594 4.85421 14.3412 5.27216C13.5862 7.94155 12.2142 10.3512 10.389 12.3375C11.1089 12.9848 11.8869 13.5688 12.7142 14.0805L11.9615 15.9627C10.8814 15.3228 9.87297 14.5749 8.95119 13.7336C7.17781 15.2694 5.09248 16.4547 2.8027 17.1819L2.1973 15.2757C4.18364 14.6449 5.99672 13.6242 7.5466 12.3036Z"></path></svg>
                      </button>
                    </div>
                    <div id="tr_result" class="ai-suggestions"></div>
                  </div>
              </div>


              <div class="form-group">
                <label for="description" class="form-label"
                  >Description (Optional)
                </label>
                <textarea
                  id="description"
                  name="description"
                  class="form-textarea"
                  placeholder="Describe your artwork, materials used, dimensions, etc..."
                >
{{ product.description if product else '' }}</textarea
                >
                <div class="form-help">
                  Provide details about your artwork to help buyers
                </div>
              </div>

              <div class="form-group prompt-group">
                <label class="form-label"> Generate with AI</label>
                <div class="voice-input-controls">
                  <select id="voice_language" class="voice-language-select">
                    <option value="en-IN">English</option>
                    <option value="hi-IN">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                    <option value="ta-IN">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                    <option value="te-IN">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
                    <option value="bn-IN">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
                    <option value="mr-IN">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                    <option value="gu-IN">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)</option>
                    <option value="kn-IN">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
                    <option value="ml-IN">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)</option>
                    <option value="pa-IN">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä (Punjabi)</option>
                  </select>
                  <button type="button" id="voice_input_btn" class="voice-input-btn" title="Voice Input">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                      <path d="M12 1C13.66 1 15 2.34 15 4V12C15 13.66 13.66 15 12 15C10.34 15 9 13.66 9 12V4C9 2.34 10.34 1 12 1ZM19 11C19 14.53 16.39 17.44 13 17.93V21H11V17.93C7.61 17.44 5 14.53 5 11H7C7 13.76 9.24 16 12 16C14.76 16 17 13.76 17 11H19Z"/>
                    </svg>
                  </button>
                </div>
                <div class="gen-input">
                <input
                  type="text"
                  id="ai_prompt"
                  class="form-input"
                  placeholder="Add prompt or image for AI to generate title & description..."
                />
                <div class="form-actions form-actions-ai">
                  <button
                    type="button"
                    id="generate_ai"
                    class="btn btn-secondary"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                    >
                      <path
                        d="M17.0007 1.20825 18.3195 3.68108 20.7923 4.99992 18.3195 6.31876 17.0007 8.79159 15.6818 6.31876 13.209 4.99992 15.6818 3.68108 17.0007 1.20825ZM8.00065 4.33325 10.6673 9.33325 15.6673 11.9999 10.6673 14.6666 8.00065 19.6666 5.33398 14.6666.333984 11.9999 5.33398 9.33325 8.00065 4.33325ZM19.6673 16.3333 18.0007 13.2083 16.334 16.3333 13.209 17.9999 16.334 19.6666 18.0007 22.7916 19.6673 19.6666 22.7923 17.9999 19.6673 16.3333Z"
                      ></path>
                    </svg>
                    Generate
                  </button>
                </div></div>
                <div id="ai_suggestions" class="ai-suggestions"></div>
              </div>

              <div class="form-group">
                <label class="form-label">Product Image</label>

                <!-- Image Upload Tabs -->
                <div class="image-upload-tabs">
                  <button
                    type="button"
                    class="tab-btn active"
                    data-tab="upload"
                    onclick="switchImageTab('upload')"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                      width="18"
                      height="18"
                    >
                      <path
                        d="M3 19h18v2H3v-2zm10-5.828L19.071 7.1l1.414 1.414L12 17 3.515 8.515 4.929 7.1 11 13.17V2h2v11.172z"
                      />
                    </svg>
                    Upload File
                  </button>
                  <button
                    type="button"
                    class="tab-btn"
                    data-tab="link"
                    onclick="switchImageTab('link')"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                      width="18"
                      height="18"
                    >
                      <path
                        d="M13.06 8.11l1.415 1.415a7 7 0 0 1 0 9.9l-.354.353a7 7 0 0 1-9.9-9.9l1.415 1.415a5 5 0 1 0 7.071 7.071l.354-.354a5 5 0 0 0 0-7.07l-1.415-1.415 1.415-1.414zm6.718 6.011l-1.414-1.414a5 5 0 1 0-7.071-7.071l-.354.354a5 5 0 0 0 0 7.07l1.415 1.415-1.415 1.414-1.414-1.414a7 7 0 0 1 0-9.9l.354-.353a7 7 0 0 1 9.9 9.9z"
                      />
                    </svg>
                    Image Link
                  </button>
                </div>

                <!-- Upload File Tab Content -->
                <div class="tab-content active" id="upload-tab">
                  <div class="file-upload-wrapper">
                    <input
                      type="file"
                      id="product_image_file"
                      name="product_image_file"
                      class="file-input"
                      accept="image/*"
                      onchange="previewImage(this, 'product-preview')"
                    />
                    <label for="product_image_file" class="file-upload-label">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                        width="48"
                        height="48"
                      >
                        <path
                          d="M21 15v3h3v2h-3v3h-2v-3h-3v-2h3v-3h2zm.008-12c.548 0 .992.445.992.993v13.014a1 1 0 0 1-.992.993H13v-2h7V4H4v14h7v2H2.992A.993.993 0 0 1 2 19.007V2.993A1 1 0 0 1 2.992 2h18.016zM8 7a2 2 0 1 1 0 4 2 2 0 0 1 0-4z"
                        />
                      </svg>
                      <span class="file-upload-text"
                        >Click to browse or drag & drop</span
                      >
                      <span class="file-upload-subtext"
                        >JPG, PNG, GIF, WebP up to 10MB</span
                      >
                    </label>
                    <div id="product-preview" class="image-preview"></div>
                  </div>
                </div>

                <!-- Image Link Tab Content -->
                <div class="tab-content" id="link-tab">
                  <input
                    type="url"
                    id="product_image"
                    name="product_image"
                    class="form-input"
                    placeholder="https://example.com/your-product-image.jpg"
                    value="{{ product.img_url if product else '' }}"
                    oninput="previewImageUrl(this.value, 'product-url-preview')"
                  />
                  <div class="form-help">
                    Paste a direct link to your product image
                  </div>
                  <div id="product-url-preview" class="image-preview"></div>
                </div>

                {% if product and product.img_url %}
                <div class="current-image-badge">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                    width="16"
                    height="16"
                  >
                    <path
                      d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-.997-6l7.07-7.071-1.414-1.414-5.656 5.657-2.829-2.829-1.414 1.414L11.003 16z"
                    />
                  </svg>
                  <span
                    >Current image will be kept if you don't upload a new
                    one</span
                  >
                </div>
                {% endif %}
              </div>

              <div class="form-actions">
                <a
                  href="{% if product %}{{ url_for('product_buy', product_id=product.product_id) }}{% else %}{{ url_for('products_page') }}{% endif %}"
                  class="btn btn-secondary cancel-btn"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      d="M11.9997 10.5865L16.9495 5.63672L18.3637 7.05093L13.4139 12.0007L18.3637 16.9504L16.9495 18.3646L11.9997 13.4149L7.04996 18.3646L5.63574 16.9504L10.5855 12.0007L5.63574 7.05093L7.04996 5.63672L11.9997 10.5865Z"
                    ></path>
                  </svg>
                  Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path d="M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"></path>
                  </svg>
                  {% if product %}Save Changes{% else %}Add Product{% endif %}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      function toggleMenu(e) {
        e?.stopPropagation?.();
        const menu = document.getElementById("mobileMenu");
        const now = menu.style.display === "flex" ? "none" : "flex";
        menu.style.display = now;
        if (now === "flex")
          document.getElementById("searchBelow").classList.remove("open");
      }

      // Image tab switching
      function switchImageTab(tab) {
        // Update tab buttons
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
          if (btn.dataset.tab === tab) {
            btn.classList.add("active");
          }
        });

        // Update tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(tab + "-tab").classList.add("active");

        // Clear the other input when switching
        if (tab === "upload") {
          document.getElementById("product_image").value = "";
          const preview = document.getElementById("product-url-preview");
          if (preview) preview.innerHTML = "";
        } else {
          document.getElementById("product_image_file").value = "";
          const preview = document.getElementById("product-preview");
          if (preview) preview.innerHTML = "";
        }
      }

      // Preview uploaded image
      function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        const file = input.files[0];

        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.innerHTML = `
                      <div class="preview-wrapper">
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="remove-preview" onclick="clearFileInput('${
                          input.id
                        }', '${previewId}')">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                            <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-11.414L9.172 7.757 7.757 9.172 10.586 12l-2.829 2.828 1.415 1.415L12 13.414l2.828 2.829 1.415-1.415L13.414 12l2.829-2.828-1.415-1.415L12 10.586z"/>
                          </svg>
                        </button>
                        <div class="preview-info">
                          <span>${file.name}</span>
                          <span>${(file.size / 1024).toFixed(1)} KB</span>
                        </div>
                      </div>
                    `;
          };
          reader.readAsDataURL(file);
        }
      }

      // Preview image from URL
      function previewImageUrl(url, previewId) {
        const preview = document.getElementById(previewId);

        if (url && url.trim()) {
          preview.innerHTML = `
                    <div class="preview-wrapper loading">
                      <img src="${url}" alt="Preview" onload="this.parentElement.classList.remove('loading')" onerror="this.parentElement.innerHTML='<div class=\\'preview-error\\'>Failed to load image</div>'">
                      <button type="button" class="remove-preview" onclick="clearUrlInput('product_image', '${previewId}')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                          <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-11.414L9.172 7.757 7.757 9.172 10.586 12l-2.829 2.828 1.415 1.415L12 13.414l2.828 2.829 1.415-1.415L13.414 12l2.829-2.828-1.415-1.415L12 10.586z"/>
                        </svg>
                      </button>
                    </div>
                  `;
        } else {
          preview.innerHTML = "";
        }
      }

      // Clear file input
      function clearFileInput(inputId, previewId) {
        document.getElementById(inputId).value = "";
        document.getElementById(previewId).innerHTML = "";
      }

      // Clear URL input
      function clearUrlInput(inputId, previewId) {
        document.getElementById(inputId).value = "";
        document.getElementById(previewId).innerHTML = "";
      }

      function hasImageSelected() {
        const url = document.getElementById("product_image").value.trim();
        const file = document.getElementById("product_image_file").files[0];
        return (url && url.length > 0) || !!file;
      }

      // Debug file upload
      document
        .getElementById("product_image_file")
        .addEventListener("change", function (e) {
          console.log("File selected:", e.target.files[0]);
          if (e.target.files[0]) {
            console.log("File name:", e.target.files[0].name);
            console.log("File size:", e.target.files[0].size);
            console.log("File type:", e.target.files[0].type);
          }
        });

      // Enforce image presence & debug form submission
      document.querySelector("form").addEventListener("submit", function (e) {
        console.log("Form submitting...");
        if (!hasImageSelected()) {
          e.preventDefault();
          alert(
            "Please provide an image URL or upload an image before submitting."
          );
          return;
        }
        const fileInput = document.getElementById("product_image_file");
        if (fileInput.files[0]) {
          console.log("File being submitted:", fileInput.files[0].name);
        } else {
          console.log("No file selected");
        }
      });

      // AI generation logic
      document
        .getElementById("generate_ai")
        .addEventListener("click", async function () {
          if (!hasImageSelected()) {
            alert(
              "Please provide an image URL or upload an image to generate suggestions."
            );
            return;
          }

          const suggestionsDiv = document.getElementById("ai_suggestions");
          suggestionsDiv.innerHTML = "Generating suggestions...";

          const imageUrl = document
            .getElementById("product_image")
            .value.trim();
          const payload = {
            type: "product",
            prompt: document.getElementById("ai_prompt").value.trim(),
            description: document.getElementById("description").value.trim(),
            image_url: imageUrl,
          };

          // Include base64 if local file is selected and no URL
          const file = document.getElementById("product_image_file").files[0];
          if (!imageUrl && file) {
            const b64 = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result.split(",")[1]);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
            payload.image_base64 = b64;
            payload.image_mime = file.type || "image/jpeg";
          }

          try {
            const res = await fetch("/api/generate_copy", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (!data.ok) {
              suggestionsDiv.innerHTML = `<div style="color:#c62828;">${
                data.error || "Failed to generate suggestions"
              }</div>`;
              return;
            }
            const items = data.suggestions || [];
            suggestionsDiv.innerHTML = items
              .map(
                (s, idx) => `
                    <div style=\"border:1px solid light-dark(#ddd, #222); background: var(--bg); border-radius: 16px; padding:12px; margin-bottom:8px;\">
                      <div style=\"font-weight:300;color: #8e8e8e; margin-bottom: 4px;\">Suggestion ${
                        idx + 1
                      }</div>
                      <div style=\"font-weight:600; text-transform:uppercase;\">${
                        s.title
                      }</div>
                      <div style=\"margin-bottom:10px; color: var(--text)\">${
                        s.description
                      }</div>
                      <button type=\"button\" class=\"btn btn-primary\" data-idx=\"${idx}\">Choose</button>
                    </div>
                  `
              )
              .join("");

            // Attach handlers
            Array.from(
              suggestionsDiv.querySelectorAll("button[data-idx]")
            ).forEach((btn) => {
              btn.addEventListener("click", () => {
                const i = parseInt(btn.getAttribute("data-idx"));
                const chosen = items[i];
                document.getElementById("product_name").value = chosen.title;
                const descEl = document.getElementById("description");
                if (descEl) descEl.value = chosen.description;
              });
            });
          } catch (err) {
            console.error(err);
            suggestionsDiv.innerHTML = `<div style=\"color:#c62828;\">Error generating suggestions.</div>`;
          }
        });

      // --- Translation UI (lightweight) ---

      document
        .getElementById("do_translate")
        .addEventListener("click", async function () {
          const lang = document.getElementById("tr_lang").value.trim();
          const title = document.getElementById("product_name").value.trim();
          const descEl = document.getElementById("description");
          const desc = descEl ? descEl.value.trim() : "";
          if (!lang) {
            alert("Choose a language");
            return;
          }
          if (!(title || desc)) {
            alert("Fill name or description first");
            return;
          }
          const resBox = document.getElementById("tr_result");
          resBox.innerHTML = "Translating...";
          try {
            const res = await fetch("/api/translate_listing", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                type: "product",
                title,
                description: desc,
                target_lang: lang,
              }),
            });
            const data = await res.json();
            if (!data.ok) {
              resBox.innerHTML = `<div style=\"color:#c62828;\">${
                data.error || "Failed to translate"
              }</div>`;
              return;
            }
            const phrases = (data.seo_phrases || [])
              .map(
                (p) =>
                  `<span style=\"display:inline-block; margin:4px; padding:4px 8px; border:1px solid #e1e1e1; border-radius:12px; font-size:12px; color:#444;\">${p}</span>`
              )
              .join("");
            resBox.innerHTML = `
                      <div style=\"border:1px solid #e9ecef; border-radius:8px; padding:12px; margin-top:8px;\">
                        <div style=\"font-weight:600; margin-bottom:6px;\">Translated</div>
                        <div style=\"margin-bottom:6px;\">Title: ${
                          data.title || ""
                        }</div>
                        <div style=\"margin-bottom:10px;\">Description: ${
                          data.description || ""
                        }</div>
                        <div style=\"margin-bottom:6px; font-weight:600;\">SEO phrases</div>
                        <div>${
                          phrases || '<i style=\\"color:#888;\\">None</i>'
                        }</div>
                        <div style=\"margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;\">
                          <button type=\"button\" class=\"btn btn-primary\" id=\"tr_apply\">Apply</button>
                        </div>
                      </div>`;
            const applyBtn = document.getElementById("tr_apply");
            applyBtn?.addEventListener("click", () => {
              document.getElementById("product_name").value =
                data.title || title;
              if (descEl) descEl.value = data.description || desc;
            });
          } catch (err) {
            console.error(err);
            resBox.innerHTML = `<div style=\"color:#c62828;\">Error translating.</div>`;
          }
        });

        // Voice Input Feature
        const voiceBtn = document.getElementById("voice_input_btn");
        const voiceLangSelect = document.getElementById("voice_language");
        const aiPromptInput = document.getElementById("ai_prompt");
        let recognition = null;
        let isRecording = false;

        // Check browser support
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();
          recognition.continuous = true;
          recognition.interimResults = true;

          recognition.onstart = () => {
            isRecording = true;
            voiceBtn.classList.add('recording');
            voiceBtn.title = 'Recording... Click to stop';
          };

          recognition.onresult = (event) => {
            // Get the final transcript (accumulate all results)
            let transcript = '';
            for (let i = 0; i < event.results.length; i++) {
              if (event.results[i].isFinal) {
                transcript += event.results[i][0].transcript + ' ';
              }
            }
            transcript = transcript.trim();
            
            if (!transcript) return; // Skip if empty
            
            const selectedLang = voiceLangSelect.value;
            
            // If Indian language, we'll translate to English for AI
            if (selectedLang !== 'en-IN') {
              // Show original transcription first
              const statusDiv = document.createElement('div');
              statusDiv.className = 'voice-status';
              statusDiv.innerHTML = `
                <div style="margin-bottom: 8px;">
                  <strong>üìù Your Input:</strong><br/>
                  "${transcript}"
                </div>
                <div style="color: #666;">‚è≥ Translating to English...</div>
              `;
              aiPromptInput.parentElement.insertBefore(statusDiv, aiPromptInput.nextSibling);
              
              // Use Google Translate API (simple approach)
              fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=en&dt=t&q=${encodeURIComponent(transcript)}`)
                .then(res => res.json())
                .then(data => {
                  const translatedText = data[0][0][0];
                  aiPromptInput.value = translatedText;
                  statusDiv.innerHTML = `
                    <div style="margin-bottom: 8px;">
                      <strong>üìù Your Input:</strong><br/>
                      "${transcript}"
                    </div>
                    <div style="color: #2196F3;">
                      <strong>üîÑ English Translation:</strong><br/>
                      "${translatedText}"
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                      ‚úì This English text will be sent to AI
                    </div>
                  `;
                  setTimeout(() => statusDiv.remove(), 25000);
                })
                .catch(err => {
                  console.error('Translation error:', err);
                  // Fallback: just use the original text
                  aiPromptInput.value = transcript;
                  statusDiv.innerHTML = `
                    <div style="margin-bottom: 8px;">
                      <strong>üìù Your Input:</strong><br/>
                      "${transcript}"
                    </div>
                    <div style="color: #ff9800;">
                      ‚ö†Ô∏è Translation failed. Using original text.
                    </div>
                  `;
                  setTimeout(() => statusDiv.remove(), 25000);
                });
            } else {
              // English, use directly
              aiPromptInput.value = transcript;
              const statusDiv = document.createElement('div');
              statusDiv.className = 'voice-status';
              statusDiv.innerHTML = `
                <div>
                  <strong>üìù Your Input:</strong><br/>
                  "${transcript}"
                </div>
              `;
              aiPromptInput.parentElement.insertBefore(statusDiv, aiPromptInput.nextSibling);
              setTimeout(() => statusDiv.remove(), 25000);
            }
          };

          recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            alert(`Voice input error: ${event.error}. Please try again.`);
            isRecording = false;
            voiceBtn.classList.remove('recording');
            voiceBtn.title = 'Voice Input';
          };

          recognition.onend = () => {
            isRecording = false;
            voiceBtn.classList.remove('recording');
            voiceBtn.title = 'Voice Input';
          };

          voiceBtn.addEventListener('click', () => {
            if (isRecording) {
              recognition.stop();
            } else {
              recognition.lang = voiceLangSelect.value;
              recognition.start();
            }
          });
        } else {
          voiceBtn.disabled = true;
          voiceBtn.style.opacity = '0.5';
          voiceBtn.title = 'Voice input not supported in this browser. Please use Chrome or Edge.';
        }
    </script>
  </body>
</html>

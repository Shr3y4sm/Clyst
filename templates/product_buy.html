<!DOCTYPE html>
<html lang="en" style="overflow: hidden">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clyst - Product Details</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../static/css/styles.css" />
    <link rel="stylesheet" href="../static/css/index.css" />
    <link rel="stylesheet" href="../static/css/product_page.css" />
  </head>
  <body>
    <!-- ===== NAVBAR ===== -->
    <nav id="topNav">
      <div class="nav">
        <div class="nav-left">
          <div class="hamburger" onclick="toggleMenu(event)">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path d="M3 4H21V6H3V4ZM3 11H21V13H3V11ZM3 18H21V20H3V18Z"></path>
            </svg>
          </div>
          <a href="{{url_for('home')}}">Clyst</a>
        </div>

        <div class="nav-center" id="navLinks">
          <a href="{{url_for('home')}}">Community Feed</a>
          <a href="{{url_for('products_page')}}">Marketplace</a>
          {% if current_user.is_authenticated %}
          <a href="{{ url_for('logout') }}">Logout</a>
          {% else %}
          <a href="{{ url_for('login') }}">Login</a>
          <a href="{{ url_for('register') }}">Register</a>
          {% endif %}
        </div>

        <div class="nav-actions">
          {% if current_user.is_authenticated %}
          <a
            href="{{ url_for('view_cart') }}"
            class="cart-btn"
            title="Shopping Cart"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M4.00436 6.41686L0.761719 3.17422L2.17593 1.76001L5.41857 5.00265H20.6603C21.2126 5.00265 21.6603 5.45037 21.6603 6.00265C21.6603 6.09997 21.6461 6.19678 21.6182 6.29L19.2182 14.29C19.0913 14.713 18.7019 15.0027 18.2603 15.0027H6.00436V17.0027H17.0044V19.0027H5.00436C4.45207 19.0027 4.00436 18.5549 4.00436 18.0027V6.41686ZM5.50436 23.0027C4.67593 23.0027 4.00436 22.3311 4.00436 21.5027C4.00436 20.6742 4.67593 20.0027 5.50436 20.0027C6.33279 20.0027 7.00436 20.6742 7.00436 21.5027C7.00436 22.3311 6.33279 23.0027 5.50436 23.0027ZM17.5044 23.0027C16.6759 23.0027 16.0044 22.3311 16.0044 21.5027C16.0044 20.6742 16.6759 20.0027 17.5044 20.0027C18.3328 20.0027 19.0044 20.6742 19.0044 21.5027C19.0044 22.3311 18.3328 23.0027 17.5044 23.0027Z"
              ></path>
            </svg>
            <span class="cart-count" id="cartCount">0</span>
          </a>
          <a
            href="{{url_for('profile', id=current_user.id)}}"
            class="profile-btn"
            title="Profile"
          >
            <svg
              width="100%"
              height="100%"
              viewBox="0 0 32 32"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M28.8662 27.5C28.7784 27.652 28.6521 27.7783 28.5001 27.8661C28.348 27.9538 28.1755 28 28 28H3.99995C3.8245 27.9998 3.65219 27.9535 3.50031 27.8656C3.34843 27.7778 3.22234 27.6515 3.13469 27.4995C3.04705 27.3475 3.00093 27.1752 3.00098 26.9997C3.00102 26.8243 3.04723 26.6519 3.13495 26.5C5.0387 23.2087 7.97245 20.8487 11.3962 19.73C9.70266 18.7218 8.38688 17.1856 7.65094 15.3572C6.91499 13.5289 6.79956 11.5095 7.32238 9.60918C7.8452 7.70887 8.97735 6.03272 10.545 4.83814C12.1126 3.64355 14.029 2.99658 16 2.99658C17.9709 2.99658 19.8873 3.64355 21.4549 4.83814C23.0226 6.03272 24.1547 7.70887 24.6775 9.60918C25.2003 11.5095 25.0849 13.5289 24.349 15.3572C23.613 17.1856 22.2972 18.7218 20.6037 19.73C24.0275 20.8487 26.9612 23.2087 28.865 26.5C28.9529 26.6519 28.9993 26.8243 28.9996 26.9998C28.9998 27.1754 28.9538 27.3479 28.8662 27.5Z"
                fill="inherit"
              />
            </svg>
          </a>
          {% endif %}
        </div>
      </div>
      <div class="mobile-menu" id="mobileMenu">
        <a href="{{url_for('home')}}">Community Feed</a>
        <a href="{{url_for('products_page')}}">Marketplace</a>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
        <a href="{{ url_for('login') }}">Login</a>
        <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
      </div>
    </nav>

    <div class="container">
      <!-- Main Content -->
      <div class="post">
        {% if product.img_url %}
        <div class="post-image">
          <img
            src="{{ product.img_url }}"
            alt="{{ product.title }}"
            class="product-image"
          />
          <button
            class="share-btn"
            data-share-url="{{ url_for('product_buy', product_id=product.product_id) }}"
            data-share-title="{{ product.title }}"
            data-share-text="By {{ product.artist.name }}"
            onclick="openShareFromEl(this)"
            title="Share Product"
            type="button"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M13.5759 17.2714L8.46576 14.484C7.83312 15.112 6.96187 15.5 6 15.5C4.067 15.5 2.5 13.933 2.5 12C2.5 10.067 4.067 8.5 6 8.5C6.96181 8.5 7.83301 8.88796 8.46564 9.51593L13.5759 6.72855C13.5262 6.49354 13.5 6.24983 13.5 6C13.5 4.067 15.067 2.5 17 2.5C18.933 2.5 20.5 4.067 20.5 6C20.5 7.933 18.933 9.5 17 9.5C16.0381 9.5 15.1669 9.11201 14.5343 8.48399L9.42404 11.2713C9.47382 11.5064 9.5 11.7501 9.5 12C9.5 12.2498 9.47383 12.4935 9.42408 12.7285L14.5343 15.516C15.167 14.888 16.0382 14.5 17 14.5C18.933 14.5 20.5 16.067 20.5 18C20.5 19.933 18.933 21.5 17 21.5C15.067 21.5 13.5 19.933 13.5 18C13.5 17.7502 13.5262 17.5064 13.5759 17.2714Z"
              ></path>
            </svg>
          </button>
        </div>
        {% endif %}
        <div class="post-info">
          <div class="product-header">
            <h1 class="product-title">{{ product.title }}</h1>
            <div class="item-desc">
              {{ product.description|linkify_hashtags|safe }}
            </div>

            <!-- Sustainability Information -->
            {% if product.is_sustainable %}
            <div class="sustainability-info">
              <span class="sustainability-badge-inline">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M20.998 3V5C20.998 14.6274 15.6255 19 8.99805 19L7.0964 18.9999C7.3079 15.9876 8.24541 14.1648 10.6939 11.9989C11.8979 10.9338 11.7965 10.3189 11.2029 10.6721C7.1193 13.1016 5.09114 16.3862 5.00119 21.6302L4.99805 22H2.99805C2.99805 20.6373 3.11376 19.3997 3.34381 18.2682C3.1133 16.9741 2.99805 15.2176 2.99805 13C2.99805 7.47715 7.4752 3 12.998 3C14.998 3 16.998 4 20.998 3Z"
                  ></path>
                </svg>
                <p style="text-transform: uppercase; line-height: 1">
                  <strong class="eco-perc"
                    >{{ product.sustainability_score }}%</strong
                  ><br />Sustainable
                </p>
              </span>
            </div>
            {% if product.sustainability_reasons %}
            <div class="sustainability-reasons">
              <details>
                <summary>Why is this sustainable?</summary>
                <ul>
                  {% set reasons = product.sustainability_reasons|from_json %}
                  {% for reason in reasons %}
                  <li>{{ reason }}</li>
                  {% endfor %}
                </ul>
              </details>
            </div>
            {% endif %} {% endif %}

            <!-- AI Detection Warning -->
            {% if product.is_ai_generated %}
            <div class="ai-detection-warning">
              <div class="ai-warning-header">
                <span class="ai-badge-inline">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      d="M7 4H9V6H15V4H17V2H19V6H17V8H19V10H23V16H21V12H20V18H17V20H19V22H15V18H9V22H5V20H7V18H4V12H3V16H1V10H5V8H7V6H5V2H7V4ZM9 11V14H11V11H9ZM13 11V14H15V11H13Z"
                    ></path>
                  </svg>
                  AI Generated Image Detected
                </span>
                <span class="ai-confidence"
                  >Confidence: {{ product.ai_confidence_score }}%</span
                >
              </div>
              <div class="ai-warning-message">
                This product image appears to be AI-generated or AI-enhanced. We
                believe in transparency and protecting authentic artisan work.
              </div>
              {% if product.ai_detection_details %}
              <div class="ai-detection-details">
                <details>
                  <summary>Detection Details</summary>
                  <div class="ai-details-content">
                    {% set ai_details = product.ai_detection_details|from_json
                    %}
                    <p>
                      <strong>Detection Method:</strong> {{
                      product.ai_detection_method }}
                    </p>
                    <p>
                      <strong>Confidence Level:</strong> {{
                      ai_details.get('confidence_level', 'N/A')|title }}
                    </p>
                    {% if ai_details.get('url_analysis') %}
                    <p><strong>URL Analysis:</strong></p>
                    <ul>
                      {% for item in ai_details.url_analysis[:3] %}
                      <li>{{ item }}</li>
                      {% endfor %}
                    </ul>
                    {% endif %}
                  </div>
                </details>
              </div>
              {% endif %}
            </div>
            {% endif %}

            <div class="product-price">
              Rs.{{ product.price }}
              <button
                class="btn icon say-aloud-btn"
                title="Say Aloud"
                type="button"
                data-title="{{ product.title|e }}"
                data-artist="{{ product.artist.name|e }}"
                data-price="{{ product.price|string|e }}"
                data-description="{{ product.description|default('No description available')|e }}"
                onclick="sayAloudFromEl(this)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="32"
                  height="32"
                  fill="#000000"
                  viewBox="0 0 256 256"
                >
                  <path
                    d="M168,32V224a8,8,0,0,1-12.91,6.31L85.25,176H40a16,16,0,0,1-16-16V96A16,16,0,0,1,40,80H85.25l69.84-54.31A8,8,0,0,1,168,32Zm32,64a8,8,0,0,0-8,8v48a8,8,0,0,0,16,0V104A8,8,0,0,0,200,96Zm32-16a8,8,0,0,0-8,8v80a8,8,0,0,0,16,0V88A8,8,0,0,0,232,80Z"
                  ></path>
                </svg>
              </button>
            </div>
            <div class="product-rating" title="Average rating">
              {% set avg = (product.avg_rating or 0) %} {% for i in range(1,6)
              %} {% if i <= avg|round(0, 'floor') %}
              <svg
                class="star-icon icon-20 star--filled"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
              >
                <path
                  d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.402 8.172L12 18.896l-7.336 3.872 1.402-8.172L.132 9.21l8.2-1.192z"
                />
              </svg>
              {% else %}
              <svg
                class="star-icon icon-20 star--empty"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
              >
                <path
                  d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.402 8.172L12 18.896l-7.336 3.872 1.402-8.172L.132 9.21l8.2-1.192z"
                />
              </svg>
              {% endif %} {% endfor %}
              <span class="avg-rating-text">
                {{ '%.1f'|format(product.avg_rating or 0) }} • {{
                product.reviews_count or 0 }}</span
              >
            </div>
          </div>

          <!-- Artist Information -->
          <div class="product-artist">
            <div class="artist">
              <div class="artist-avatar">
                {{ product.artist.name[0].upper() }}
              </div>
              <div class="artist-info">
                <h3
                  onclick="location.href='{{ url_for('view_profile', user_id=product.artist.id) }}'"
                >
                  {{ product.artist.name }}
                </h3>
                <p>Artisan</p>
              </div>
            </div>
            <button
              class="btn btn-primary"
              type="button"
              onclick="openContactModal()"
              title="Contact Seller"
            >
              Contact Seller
            </button>
          </div>

          <!-- Product Meta -->
          <div class="product-meta">
            <div class="meta-item">
              <div class="meta-label">Added on</div>
              <div class="meta-value">{{ product.created_at }}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Category</div>
              <div class="meta-value">Artwork</div>
            </div>
          </div>
          <div class="buttons">
            {% if current_user.is_authenticated and current_user.id ==
            product.artist_id %}
            <button
              class="btn btn-secondary"
              onclick="if(confirm('Delete this product?')) window.location.href='{{ url_for('delete_products', product_id=product.product_id) }}'"
              title="Delete Product"
            >
              Delete
            </button>
            {% elif current_user.is_authenticated and current_user.id !=
            product.artist_id %}
            <button
              class="btn btn-secondary"
              onclick="addToCart({{ product.product_id }})"
              data-product-id="{{ product.product_id }}"
              title="Add to Cart"
              type="button"
            >
              Add to Cart
            </button>
            {% elif not current_user.is_authenticated %}
            <button
              class="btn btn-secondary"
              onclick="window.location.href='{{ url_for('login') }}?next={{ url_for('product_buy', product_id=product.product_id) }}'"
              title="Login to add to cart"
              type="button"
            >
              Add to Cart
            </button>
            {% endif %} {% if current_user.id != product.artist_id %}
            <a
              href="javascript:void(0)"
              onclick="handlePurchase()"
              class="btn btn-primary"
              >Purchase</a
            >
            {% else %}
            <button
              class="btn btn-primary"
              onclick="openEditModal()"
              title="Edit Product"
              type="button"
            >
              Edit
            </button>
            {% endif %}
          </div>

          <!-- Product Chatbot -->
          <div class="product-chatbot-section">
            <button
              class="btn btn-primary ask-abt-prod"
              onclick="toggleProductChat()"
              type="button"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M6.45455 19L2 22.5V4C2 3.44772 2.44772 3 3 3H21C21.5523 3 22 3.44772 22 4V18C22 18.5523 21.5523 19 21 19H6.45455ZM5.76282 17H20V5H4V18.3851L5.76282 17ZM11 10H13V12H11V10ZM7 10H9V12H7V10ZM15 10H17V12H15V10Z"
                ></path>
              </svg>
              <span>Ask about this product</span>
            </button>

            <!-- Chat Modal -->
            <div class="product-chat-modal" id="productChatModal">
              <div class="chat-modal-header">
                <h3>Product Assistant</h3>
                <button
                  class="btn btn-secondary close-chat"
                  onclick="toggleProductChat()"
                  type="button"
                  aria-label="Close chat"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      d="M12 10.586L16.95 5.63599L18.364 7.04999L13.414 12L18.364 16.95L16.95 18.364L12 13.414L7.04999 18.364L5.63599 16.95L10.586 12L5.63599 7.04999L7.04999 5.63599L12 10.586Z"
                    ></path>
                  </svg>
                </button>
              </div>

              <div class="chat-suggestions" id="chatSuggestions">
                <!-- <p class="suggestions-label">Quick questions:</p> -->
                <button
                  class="btn btn-secondary suggestion-btn"
                  onclick="askQuestion('What materials is this made from?')"
                  type="button"
                >
                  What materials is this made from?
                </button>
                <button
                  class="btn btn-secondary suggestion-btn"
                  onclick="askQuestion('How long will delivery take?')"
                  type="button"
                >
                  How long will delivery take?
                </button>
                <button
                  class="btn btn-secondary suggestion-btn"
                  onclick="askQuestion('Can I customize this?')"
                  type="button"
                >
                  Can I customize this?
                </button>
                <button
                  class="btn btn-secondary suggestion-btn"
                  onclick="askQuestion('Is this handmade?')"
                  type="button"
                >
                  Is this handmade?
                </button>
              </div>

              <div class="chat-messages" id="chatMessages"></div>

              <div class="chat-input-container">
                <input
                  type="text"
                  id="chatInput"
                  placeholder="Ask a question about this product..."
                  class="chat-input"
                  onkeypress="if(event.key==='Enter') sendChatMessage()"
                />
                <button
                  class="btn btn-primary"
                  onclick="sendChatMessage()"
                  type="button"
                  aria-label="Send message"
                >
                  ASK
                </button>
              </div>
            </div>
          </div>

          {% if current_user.is_authenticated %}
          <h3 class="comment-head">Reviews</h3>
          <form
            action="{{ url_for('add_product_comment', product_id=product.product_id) }}"
            method="POST"
            class="comment-section"
            id="product-comment-form"
          >
            <input
              type="hidden"
              name="anchor"
              value="product-{{ product.product_id }}-comments"
            />
            <input type="hidden" name="rating" id="rating-hidden" value="0" />
            <div class="artist-avatar">{{ current_user.name[0].upper() }}</div>
            <input
              type="text"
              name="comment"
              placeholder="Write a comment..."
              required
            />
            <button
              class="btn btn-primary"
              type="submit"
              title="Submit comment"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M3 12.9999H9V10.9999H3V1.84558C3 1.56944 3.22386 1.34558 3.5 1.34558C3.58425 1.34558 3.66714 1.36687 3.74096 1.40747L22.2034 11.5618C22.4454 11.6949 22.5337 11.9989 22.4006 12.2409C22.3549 12.324 22.2865 12.3924 22.2034 12.4381L3.74096 22.5924C3.499 22.7255 3.19497 22.6372 3.06189 22.3953C3.02129 22.3214 3 22.2386 3 22.1543V12.9999Z"
                ></path>
              </svg>
              <span class="sr-only">Submit comment</span>
            </button>
          </form>
          <div
            class="rating-input"
            id="comment-rating"
            data-current-rating="{{ product.current_user_rating or 0 }}"
            aria-label="Rate this product"
          >
            <span class="rating-label">Rate</span>
            <div class="rating-stars" role="radiogroup" aria-label="Stars">
              {% for i in range(1,6) %}
              <button
                type="button"
                class="star-btn"
                data-value="{{ i }}"
                aria-label="{{ i }} star{% if i>1 %}s{% endif %}"
              >
                <svg
                  class="star-icon icon-20"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.402 8.172L12 18.896l-7.336 3.872 1.402-8.172L.132 9.21l8.2-1.192z"
                  />
                </svg>
              </button>
              {% endfor %}
            </div>
          </div>
          {% endif %} {% if product.comments %}
          <h3 class="comment-head" style="margin: 0">Comments</h3>
          <div class="comments-list">
            {% for comment in product.comments %}
            <div class="comments" id="product-comment-{{ comment.id }}">
              <div class="user-id-info">
                <div class="artist-avatar">
                  {{ comment.artist.name[0].upper() if comment.artist.name else
                  'U' }}
                </div>
                <div class="artist-name">
                  {% if comment.artist.id %}
                  <a
                    href="{{ url_for('view_profile', user_id=comment.artist.id) }}"
                    class="post-username"
                    >{{ comment.artist.name }}</a
                  >
                  {% else %}
                  <span class="post-username">{{ comment.artist.name }}</span>
                  {% endif %}
                  <p class="post-user-email">
                    {{ comment.artist.email }} - {{ comment.created_at }}
                  </p>
                </div>
                {% if current_user.is_authenticated and current_user.id ==
                comment.artist.id %}
                <form
                  action="{{ url_for('delete_product_comment', comment_id=comment.id) }}"
                  method="POST"
                  class="form-inline"
                >
                  <input
                    type="hidden"
                    name="anchor"
                    value="product-{{ product.product_id }}-comments"
                  />
                  <button
                    class="action-btn delete-btn"
                    onclick="return confirm('Delete this comment?')"
                    type="submit"
                    title="Delete comment"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      width="24"
                      height="24"
                      fill="currentColor"
                    >
                      <path
                        d="M17 6H22V8H20V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V8H2V6H7V3C7 2.44772 7.44772 2 8 2H16C16.5523 2 17 2.44772 17 3V6ZM9 11V17H11V11H9ZM13 11V17H15V11H13ZM9 4V6H15V4H9Z"
                      ></path>
                    </svg>
                    <span class="sr-only">Delete comment</span>
                  </button>
                </form>
                {% endif %}
              </div>

              {% set ur = product.ratings_map.get(comment.artist.id) if
              product.ratings_map else 0 %} {% if ur %}
              <div class="products-rating">
                {% for i in range(1,6) %} {% if i <= ur %}
                <svg
                  class="star-icon icon-20 star--filled"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.402 8.172L12 18.896l-7.336 3.872 1.402-8.172L.132 9.21l8.2-1.192z"
                  />
                </svg>
                {% else %}
                <svg
                  class="star-icon icon-20 star--empty"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.402 8.172L12 18.896l-7.336 3.872 1.402-8.172L.132 9.21l8.2-1.192z"
                  />
                </svg>
                {% endif %} {% endfor %}
              </div>
              {% endif %}
              <p class="comment-p">{{ comment.content }}</p>
              <div class="icon-set">
                <button
                  class="say-aloud-btn"
                  title="Say Aloud"
                  type="button"
                  data-comment="{{ comment.content|e }}"
                  data-author="{{ comment.artist.name|e if comment.artist.name else '' }}"
                  onclick="sayCommentFromEl(this)"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="32"
                    height="32"
                    fill="#000000"
                    viewBox="0 0 256 256"
                  >
                    <path
                      d="M168,32V224a8,8,0,0,1-12.91,6.31L85.25,176H40a16,16,0,0,1-16-16V96A16,16,0,0,1,40,80H85.25l69.84-54.31A8,8,0,0,1,168,32Zm32,64a8,8,0,0,0-8,8v48a8,8,0,0,0,16,0V104A8,8,0,0,0,200,96Zm32-16a8,8,0,0,0-8,8v80a8,8,0,0,0,16,0V88A8,8,0,0,0,232,80Z"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <script src="../static/js/app.js"></script>
    <script>
      function toggleMenu(e) {
        e?.stopPropagation?.();
        const menu = document.getElementById("mobileMenu");
        const now = menu.style.display === "flex" ? "none" : "flex";
        menu.style.display = now;
        if (now === "flex")
          document.getElementById("searchBelow").classList.remove("open");
      }

      document.addEventListener("DOMContentLoaded", function () {
        const path = window.location.pathname.split("/").pop();
        document
          .querySelectorAll(".nav-center a, .mobile-menu a")
          .forEach((link) => {
            if (link.getAttribute("href") === path) {
              link.classList.add("active");
            } else {
              link.classList.remove("active");
            }
          });
      });

      function handlePurchase() {
        // Show a modal or redirect to payment gateway
        alert(
          "Payment gateway integration would go here!\n\nThis would typically redirect to:\n- Stripe\n- PayPal\n- Razorpay\n- Or other payment processors"
        );
      }

      function sayAloud(text) {
        const message = new SpeechSynthesisUtterance();
        message.text = `The title of the artwork is ${text.title}. It is created by ${text.artist}. The price of the artwork is Rs.${text.price}. The description says it is ${text.description}.`;
        window.speechSynthesis.speak(message); // Start speaking
      }

      async function copyToClipboard(textToCopy) {
        try {
          await navigator.clipboard.writeText(textToCopy);
          alert("Text copied to clipboard");
        } catch (err) {
          alert("Failed to copy text: " + err);
        }
      }
      function sayAloudFromEl(el) {
        const title = el.getAttribute("data-title") || "";
        const artist = el.getAttribute("data-artist") || "";
        const price = el.getAttribute("data-price") || "";
        const description = el.getAttribute("data-description") || "";
        const message = new SpeechSynthesisUtterance();
        message.text = `The title of the artwork is ${title}. It is created by ${artist}. The price of the artwork is Rs.${price}. The description says: ${description}.`;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(message);
      }
      // Speak a specific comment provided by data attributes on the element
      function sayCommentFromEl(el) {
        const text = el.getAttribute("data-comment") || "";
        const author = el.getAttribute("data-author") || "";
        if (!text) return;
        const msg = new SpeechSynthesisUtterance();
        msg.text = author ? `${author} says: ${text}` : text;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(msg);
      }

      // Cart functionality
      async function addToCart(productId) {
        const button = document.querySelector(
          `[data-product-id="${productId}"]`
        );
        const originalText = button.innerHTML;

        // Show loading state
        button.disabled = true;
        button.innerHTML = '<div class="loading"></div> Adding...';

        try {
          const response = await fetch(`/cart/add/${productId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (data.success) {
            // Show success message
            showCartMessage("Product added to cart!", "success");
            // Update cart count
            updateCartCount();
            // Reset button
            button.innerHTML = "✓ Added to Cart";
            button.style.background = "#28a745";
            setTimeout(() => {
              button.innerHTML = originalText;
              button.style.background = "";
              button.disabled = false;
            }, 2000);
          } else {
            throw new Error(data.message || "Failed to add to cart");
          }
        } catch (error) {
          console.error("Error adding to cart:", error);
          showCartMessage("Failed to add to cart", "error");
          button.innerHTML = originalText;
          button.disabled = false;
        }
      }

      async function updateCartCount() {
        try {
          const response = await fetch("/api/cart/count");
          const data = await response.json();
          document.getElementById("cartCount").textContent = data.count;
        } catch (error) {
          console.error("Error updating cart count:", error);
        }
      }

      function showCartMessage(message, type) {
        // Remove existing message
        const existingMessage = document.querySelector(".cart-message");
        if (existingMessage) {
          existingMessage.remove();
        }

        // Create new message
        const messageEl = document.createElement("div");
        messageEl.className = `cart-message ${type}`;
        messageEl.textContent = message;
        document.body.appendChild(messageEl);

        // Show message
        setTimeout(() => messageEl.classList.add("show"), 100);

        // Hide message after 3 seconds
        setTimeout(() => {
          messageEl.classList.remove("show");
          setTimeout(() => messageEl.remove(), 300);
        }, 3000);
      }

      // Update cart count on page load
      document.addEventListener("DOMContentLoaded", function () {
        updateCartCount();
        initCommentRatingWidget();
      });
    </script>
    <script>
      function initCommentRatingWidget() {
        const wrap = document.getElementById("comment-rating");
        if (!wrap) return;
        const hidden = document.getElementById("rating-hidden");
        const stars = wrap.querySelectorAll(".star-btn");
        const current =
          parseInt(wrap.getAttribute("data-current-rating") || "0", 10) || 0;
        function paint(n) {
          stars.forEach((btn) => {
            const v = parseInt(btn.getAttribute("data-value"), 10) || 0;
            btn.classList.toggle("active", v <= n);
          });
        }
        if (current) {
          hidden.value = String(current);
          paint(current);
        }
        stars.forEach((btn) => {
          btn.addEventListener("mouseover", () =>
            paint(parseInt(btn.getAttribute("data-value"), 10) || 0)
          );
          btn.addEventListener("focus", () =>
            paint(parseInt(btn.getAttribute("data-value"), 10) || 0)
          );
          btn.addEventListener("click", () => {
            const val = parseInt(btn.getAttribute("data-value"), 10) || 0;
            hidden.value = String(val);
            paint(val);
          });
        });
        wrap.addEventListener("mouseleave", () =>
          paint(parseInt(hidden.value || "0", 10) || 0)
        );
      }
    </script>

    <!-- Edit Product Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Product</h2>
          <button
            class="close-modal"
            onclick="closeEditModal()"
            type="button"
            aria-label="Close modal"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              width="20"
              height="20"
            >
              <path
                d="M12 10.586L16.95 5.63599L18.364 7.04999L13.414 12L18.364 16.95L16.95 18.364L12 13.414L7.04999 18.364L5.63599 16.95L10.586 12L5.63599 7.04999L7.04999 5.63599L12 10.586Z"
              ></path>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <form id="editProductForm" enctype="multipart/form-data">
            <div class="form-group">
              <label for="edit_product_name" class="form-label"
                >Product Name</label
              >
              <input
                type="text"
                id="edit_product_name"
                name="product_name"
                class="form-input"
                value="{{ product.title }}"
                required
              />
            </div>

            <div class="form-group">
              <label for="edit_price" class="form-label">Price (Rs.)</label>
              <input
                type="number"
                id="edit_price"
                name="price"
                class="form-input"
                step="0.01"
                min="0"
                value="{{ product.price }}"
                required
              />
            </div>

            <div class="form-group">
              <label for="edit_description" class="form-label"
                >Description</label
              >
              <textarea
                id="edit_description"
                name="description"
                class="form-textarea"
                rows="4"
              >
{{ product.description }}</textarea
              >
            </div>

            <div class="form-group">
              <label for="edit_product_image" class="form-label"
                >New Image (Optional)</label
              >

              <div class="file-upload-wrapper">
                <input
                  type="file"
                  id="product_image_file"
                  name="product_image_file"
                  class="file-input"
                  accept="image/*"
                  onchange="previewImage(this, 'product-preview')"
                />
                <label for="product_image_file" class="file-upload-label">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                    width="48"
                    height="48"
                  >
                    <path
                      d="M21 15v3h3v2h-3v3h-2v-3h-3v-2h3v-3h2zm.008-12c.548 0 .992.445.992.993v13.014a1 1 0 0 1-.992.993H13v-2h7V4H4v14h7v2H2.992A.993.993 0 0 1 2 19.007V2.993A1 1 0 0 1 2.992 2h18.016zM8 7a2 2 0 1 1 0 4 2 2 0 0 1 0-4z"
                    />
                  </svg>
                  <span class="file-upload-text"
                    >Click to browse or drag & drop</span
                  >
                  <span class="file-upload-subtext"
                    >JPG, PNG, GIF, WebP up to 10MB</span
                  >
                </label>
                <div id="product-preview" class="image-preview"></div>
              </div>
              {% if product.img_url %}
              <div class="current-image">
                <img
                  src="{{ product.img_url }}"
                  alt="Current product image"
                  class="current-image-preview"
                />
                <small class="form-help">Current image</small>
              </div>
              {% endif %}
            </div>

            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="closeEditModal()"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                Save Changes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <style>
      /* Edit Product Modal - Modern Design */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 2000;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        position: relative;
        background: var(--card);
        margin: 40px auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-height: calc(100vh - 80px);
        overflow: hidden;
        animation: slideUp 0.3s ease;
        border: 1px solid light-dark(#e5e5e5, #333);
      }

      @keyframes slideUp {
        from {
          transform: translateY(30px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        padding: 10px 20px;
        border-bottom: 1px solid light-dark(#e5e5e5, #333);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--card);
      }

      .modal-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 500;
        color: var(--text);
      }

      .modal-body {
        overflow-y: auto;
        max-height: calc(100vh - 240px);
      }

      .close-modal {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: normal;
        color: var(--muted);
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s;
        background: transparent;
        border: none;
      }

      .close-modal svg {
        width: 28px;
        height: 28px;
      }

      .close-modal:hover {
        background: light-dark(#f5f5f5, #2a2a2a);
        color: var(--text);
      }

      /* Form styles */
      .modal .form-group {
        padding: 0 20px;
        margin-bottom: 20px;
      }

      .modal .form-group:first-child {
        margin-top: 20px;
      }

      #contactSellerForm .form-label {
        margin: 20px 0 8px 0;
      }

      .modal .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
        color: var(--text);
      }

      .modal .form-input,
      .modal .form-textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid light-dark(#d4d4d4, #404040);
        border-radius: 8px;
        font-size: 15px;
        color: var(--text);
        background: var(--card);
        transition: all 0.2s;
        font-family: inherit;
      }

      .modal .form-input:focus,
      .modal .form-textarea:focus {
        outline: none;
        border-color: var(--text);
        box-shadow: 0 0 0 3px
          light-dark(rgba(0, 0, 0, 0.05), rgba(255, 255, 255, 0.05));
      }

      .modal .form-textarea {
        resize: vertical;
        min-height: 120px;
        line-height: 1.15;
      }

      .modal .form-input[type="file"] {
        padding: 10px;
        cursor: pointer;
      }

      .modal .form-actions {
        margin-top: 28px;
        padding: 20px;
        border-top: 1px solid light-dark(#e5e5e5, #333);
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .modal .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .modal .btn-secondary {
        background: light-dark(#f5f5f5, #2a2a2a);
        color: var(--text);
      }

      .modal .btn-secondary:hover {
        background: light-dark(#e5e5e5, #333);
      }

      .modal .btn-primary {
        background: var(--text);
        color: var(--card);
      }

      .modal .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .modal .current-image {
        margin: 12px 0 0 0;
        padding: 12px;
        background: light-dark(#f9f9f9, #1a1a1a);
        border-radius: 8px;
        border: 1px solid light-dark(#e5e5e5, #333);
      }

      .modal .current-image-preview {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 6px;
        display: block;
        margin-bottom: 8px;
      }

      .modal .form-help {
        font-size: 13px;
        color: var(--muted);
        display: block;
      }

      /* Loading indicator */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(2px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1;
        border-radius: 12px;
      }

      .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid light-dark(#e5e5e5, #333);
        border-top: 4px solid var(--text);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Mobile responsive */
      @media (max-width: 640px) {
        .modal-content {
          margin: 20px auto;
          width: 95%;
          max-height: calc(100vh - 40px);
        }

        .modal-header {
          padding: 20px;
        }

        .modal-body {
          padding: 20px;
        }

        .modal .form-actions {
          flex-direction: column-reverse;
          gap: 10px;
        }

        .modal .btn {
          width: 100%;
        }
      }
    </style>

    <script>
      // Modal functions
      function openEditModal() {
        document.getElementById("editModal").style.display = "block";
      }

      function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("editModal");
        if (event.target == modal) {
          closeEditModal();
        }
      };

      // Handle form submission
      document
        .getElementById("editProductForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const form = e.target;
          const formData = new FormData(form);

          // Show loading state
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalBtnText = submitBtn.innerHTML;
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<div class="loading-spinner"></div> Saving...';

          try {
            const response = await fetch(
              '{{ url_for("add_products", product_id=product.product_id) }}',
              {
                method: "POST",
                body: formData,
                headers: {
                  "X-Requested-With": "XMLHttpRequest",
                },
                credentials: "same-origin",
              }
            );

            const data = await response.json();

            if (data.success) {
              // Update product details in the page
              const productData = data.product;
              document.querySelector(".product-title").textContent =
                productData.title;
              document.querySelector(".product-price").textContent =
                "Rs." + productData.price;
              document.querySelector(".item-desc").textContent =
                productData.description;

              // Show success message
              showCartMessage("Product updated successfully!", "success");

              // If a new image was uploaded and returned
              if (productData.img_url) {
                const imgElements = document.querySelectorAll(".product-image");
                imgElements.forEach((img) => {
                  img.src = productData.img_url;
                });
              }

              // Close modal
              closeEditModal();
            } else {
              throw new Error(data.message || "Failed to update product");
            }
          } catch (error) {
            console.error("Error:", error);
            showCartMessage(
              error.message || "Failed to update product",
              "error"
            );

            // Reset button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
          }
        });

      // ===== Contact Seller Modal =====
      function openContactModal() {
        const modal = document.getElementById("contactModal");
        if (modal) modal.style.display = "block";
      }
      function closeContactModal() {
        const modal = document.getElementById("contactModal");
        if (modal) modal.style.display = "none";
      }
      // Close contact modal when clicking backdrop
      window.addEventListener("click", function (event) {
        const modal = document.getElementById("contactModal");
        if (event.target === modal) {
          closeContactModal();
        }
      });

      // Submit contact form via AJAX
      const contactForm = document.getElementById("contactSellerForm");
      if (contactForm) {
        contactForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          const form = e.target;
          const formData = new FormData(form);
          const submitBtn = form.querySelector('button[type="submit"]');
          const original = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = "Sending...";
          try {
            const res = await fetch('{{ url_for("start_conversation") }}', {
              method: "POST",
              body: formData,
              headers: { "X-Requested-With": "XMLHttpRequest" },
              credentials: "same-origin",
            });
            const data = await res.json();
            if (data.success) {
              showCartMessage("Message sent to seller", "success");
              closeContactModal();
              if (data.url) {
                window.location.href = data.url;
              }
            } else {
              throw new Error(data.message || "Failed to send message");
            }
          } catch (err) {
            console.error(err);
            showCartMessage(err.message || "Failed to send message", "error");
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = original;
          }
        });
      }
    </script>

    <!-- Contact Seller Modal -->
    {% if current_user.is_authenticated and current_user.id != product.artist_id
    %}
    <div id="contactModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Contact Seller</h2>
          <span class="close-modal" onclick="closeContactModal()">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              width="20"
              height="20"
            >
              <path
                d="M12 10.586L16.95 5.63599L18.364 7.04999L13.414 12L18.364 16.95L16.95 18.364L12 13.414L7.04999 18.364L5.63599 16.95L10.586 12L5.63599 7.04999L7.04999 5.63599L12 10.586Z"
              ></path>
            </svg>
          </span>
        </div>
        <div class="modal-body">
          <form
            id="contactSellerForm"
            action="{{ url_for('start_conversation') }}"
            enctype="multipart/form-data"
            method="post"
          >
            <input
              type="hidden"
              name="product_id"
              value="{{ product.product_id }}"
            />
            <div class="form-group">
              <label for="contact_message" class="form-label"
                >Your message</label
              >
              <textarea
                id="contact_message"
                name="message"
                class="form-textarea"
                rows="4"
                placeholder="Ask about availability, shipping, customizations..."
                required
              ></textarea>
            </div>
            <div class="form-group">
              <label for="contact_attachment" class="form-label"
                >Attachment (optional)</label
              >

              <div class="file-upload-wrapper">
                <input
                  type="file"
                  id="product_image_file"
                  name="product_image_file"
                  class="file-input"
                  accept="image/*"
                  onchange="previewImage(this, 'product-preview')"
                />
                <label for="product_image_file" class="file-upload-label">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                    width="48"
                    height="48"
                  >
                    <path
                      d="M21 15v3h3v2h-3v3h-2v-3h-3v-2h3v-3h2zm.008-12c.548 0 .992.445.992.993v13.014a1 1 0 0 1-.992.993H13v-2h7V4H4v14h7v2H2.992A.993.993 0 0 1 2 19.007V2.993A1 1 0 0 1 2.992 2h18.016zM8 7a2 2 0 1 1 0 4 2 2 0 0 1 0-4z"
                    />
                  </svg>
                  <span class="file-upload-text"
                    >Click to browse or drag & drop</span
                  >
                  <span class="file-upload-subtext"
                    >JPG, PNG, GIF, WebP up to 10MB</span
                  >
                </label>
                <div id="product-preview" class="image-preview"></div>
              </div>
            </div>
            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="closeContactModal()"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                Send Message
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  </body>
</html>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const contactForm = document.getElementById("contactSellerForm");
    if (contactForm) {
      contactForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        const original = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = "Sending...";
        try {
          const res = await fetch(form.action, {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" },
            credentials: "same-origin",
          });
          const data = await res.json();
          if (data.success) {
            showCartMessage("Message sent to seller", "success");
            closeContactModal();
            if (data.url) {
              window.location.href = data.url;
            }
          } else {
            throw new Error(data.message || "Failed to send message");
          }
        } catch (err) {
          console.error(err);
          showCartMessage(err.message || "Failed to send message", "error");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = original;
        }
      });
    }
  });

  // Product Chatbot Functions
  function toggleProductChat() {
    const modal = document.getElementById("productChatModal");
    modal.classList.toggle("show");
    modal.style.display = modal.classList.contains("show") ? "block" : "none";
    if (modal.classList.contains("show")) {
      document.getElementById("chatInput").focus();
    }
  }

  function askQuestion(question) {
    document.getElementById("chatInput").value = question;
    sendChatMessage();
  }

  function addMessage(text, isUser = false, suggestions = []) {
    const messagesContainer = document.getElementById("chatMessages");
    const messageDiv = document.createElement("div");
    messageDiv.className = `chat-message ${
      isUser ? "user-message" : "bot-message"
    }`;

    const textDiv = document.createElement("div");
    textDiv.className = "message-text";
    textDiv.textContent = text;
    messageDiv.appendChild(textDiv);

    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    // Update suggestions if provided
    if (!isUser && suggestions && suggestions.length > 0) {
      updateSuggestions(suggestions);
    }
  }

  function updateSuggestions(suggestions) {
    const suggestionsContainer = document.getElementById("chatSuggestions");
    suggestionsContainer.innerHTML = "";
    suggestions.forEach((suggestion) => {
      const btn = document.createElement("button");
      btn.className = "btn btn-suggestion suggestion-btn";
      btn.textContent = suggestion;
      btn.type = "button";
      btn.onclick = () => askQuestion(suggestion);
      suggestionsContainer.appendChild(btn);
    });
  }

  async function sendChatMessage() {
    const input = document.getElementById("chatInput");
    const question = input.value.trim();

    if (!question) return;

    // Add user message
    addMessage(question, true);
    input.value = "";

    // Show typing indicator
    const typingDiv = document.createElement("div");
    typingDiv.className = "chat-message bot-message typing";
    typingDiv.innerHTML =
      '<div class="message-text"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>';
    typingDiv.id = "typingIndicator";
    document.getElementById("chatMessages").appendChild(typingDiv);

    try {
      const response = await fetch(`/product/{{ product.product_id }}/chat`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ question }),
      });

      const data = await response.json();

      // Remove typing indicator
      document.getElementById("typingIndicator")?.remove();

      if (data.success) {
        addMessage(data.answer, false, data.suggestions);
      } else {
        addMessage(
          "Sorry, I encountered an error. Please try contacting the seller directly.",
          false
        );
      }
    } catch (error) {
      console.error("Chat error:", error);
      document.getElementById("typingIndicator")?.remove();
      addMessage(
        "Sorry, I encountered an error. Please try contacting the seller directly.",
        false
      );
    }
  }

  // Preview uploaded image
  function previewImage(input, previewId) {
    const preview = document.getElementById(previewId);
    const file = input.files[0];

    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        preview.innerHTML = `
                      <div class="preview-wrapper">
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="remove-preview" onclick="clearFileInput('${
                          input.id
                        }', '${previewId}')">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                            <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-11.414L9.172 7.757 7.757 9.172 10.586 12l-2.829 2.828 1.415 1.415L12 13.414l2.828 2.829 1.415-1.415L13.414 12l2.829-2.828-1.415-1.415L12 10.586z"/>
                          </svg>
                        </button>
                        <div class="preview-info">
                          <span>${file.name}</span>
                          <span>${(file.size / 1024).toFixed(1)} KB</span>
                        </div>
                      </div>
                    `;
      };
      reader.readAsDataURL(file);
    }
  }

  // Clear file input
  function clearFileInput(inputId, previewId) {
    document.getElementById(inputId).value = "";
    document.getElementById(previewId).innerHTML = "";
  }
</script>

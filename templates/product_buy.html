<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clyst - Product Details</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../static/css/styles.css" />
    <link rel="stylesheet" href="../static/css/index.css" />
    <link rel="stylesheet" href="../static/css/product_page.css" />
  </head>
  <body>
    <!-- ===== NAVBAR ===== -->
    <nav id="topNav">
      <div class="nav">
        <div class="nav-left">
          <div class="hamburger" onclick="toggleMenu(event)">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path d="M3 4H21V6H3V4ZM3 11H21V13H3V11ZM3 18H21V20H3V18Z"></path>
            </svg>
          </div>
          <a href="{{url_for('home')}}">Clyst</a>
        </div>

        <div class="nav-center" id="navLinks">
          <a href="{{url_for('home')}}">Community Feed</a>
          <a href="{{url_for('products_page')}}">Marketplace</a>
          {% if current_user.is_authenticated %}
          <a href="{{ url_for('logout') }}">Logout</a>
          {% else %}
          <a href="{{ url_for('login') }}">Login</a>
          <a href="{{ url_for('register') }}">Register</a>
          {% endif %}
        </div>

        <div class="nav-actions">
          {% if current_user.is_authenticated %}
          <a
            href="{{ url_for('view_cart') }}"
            class="cart-btn"
            title="Shopping Cart"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4.00436 6.41686L0.761719 3.17422L2.17593 1.76001L5.41857 5.00265H20.6603C21.2126 5.00265 21.6603 5.45037 21.6603 6.00265C21.6603 6.09997 21.6461 6.19678 21.6182 6.29L19.2182 14.29C19.0913 14.713 18.7019 15.0027 18.2603 15.0027H6.00436V17.0027H17.0044V19.0027H5.00436C4.45207 19.0027 4.00436 18.5549 4.00436 18.0027V6.41686ZM5.50436 23.0027C4.67593 23.0027 4.00436 22.3311 4.00436 21.5027C4.00436 20.6742 4.67593 20.0027 5.50436 20.0027C6.33279 20.0027 7.00436 20.6742 7.00436 21.5027C7.00436 22.3311 6.33279 23.0027 5.50436 23.0027ZM17.5044 23.0027C16.6759 23.0027 16.0044 22.3311 16.0044 21.5027C16.0044 20.6742 16.6759 20.0027 17.5044 20.0027C18.3328 20.0027 19.0044 20.6742 19.0044 21.5027C19.0044 22.3311 18.3328 23.0027 17.5044 23.0027Z"></path></svg>
            <span class="cart-count" id="cartCount">0</span>
          </a>
          <a
            href="{{url_for('profile', id=current_user.id)}}"
            class="profile-btn"
            title="Profile"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path
                d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"
              />
            </svg>
          </a>
          {% endif %}
        </div>
      </div>
      <div class="mobile-menu" id="mobileMenu">
        <a href="{{url_for('home')}}">Community Feed</a>
        <a href="{{url_for('products_page')}}">Marketplace</a>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
        <a href="{{ url_for('login') }}">Login</a>
        <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
      </div>
    </nav>

    <div class="container">
      <!-- Main Content -->
      <div class="post">
        {% if product.img_url %}
        <div class="post-image">
          <img
            src="{{ product.img_url }}"
            alt="{{ product.title }}"
            class="product-image"
          />
        </div>
        {% endif %}
        <div class="post-info">

          <div class="product-header">
            <h1 class="product-title">{{ product.title }}</h1>
            <div class="product-rating" title="Average rating">
              {% set avg = (product.avg_rating or 0) %}
              {% for i in range(1,6) %}
                {% if i <= avg|round(0, 'floor') %}
                <svg class="star-icon icon-20 star--filled" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.402 8.172L12 18.896l-7.336 3.872 1.402-8.172L.132 9.21l8.2-1.192z"/></svg>
                {% else %}
                <svg class="star-icon icon-20 star--empty" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.402 8.172L12 18.896l-7.336 3.872 1.402-8.172L.132 9.21l8.2-1.192z"/></svg>
                {% endif %}
              {% endfor %}
              <span class="avg-rating-text">{{ '%.1f'|format(product.avg_rating or 0) }} ({{ product.reviews_count or 0 }})</span>
            </div>
            <div class="product-price">Rs.{{ product.price }}</div>
          </div>
          <div class="item-desc">{{product.description}}</div>

          
        {% if current_user.is_authenticated %}
        <h3 class="reviews-heading">Reviews & Rating</h3>
        <form
          action="{{ url_for('add_product_comment', product_id=product.product_id) }}"
          method="POST"
          class="comment-section"
        >
          <input
            type="hidden"
            name="anchor"
            value="product-{{ product.product_id }}-comments"
          />
          <div class="artist-avatar">{{ current_user.name[0].upper() }}</div>
          <div class="rating-input" id="comment-rating" data-current-rating="{{ product.current_user_rating or 0 }}" aria-label="Rate this product">
            <span class="rating-label">Rating</span>
            <div class="rating-stars" role="radiogroup" aria-label="Stars">
              {% for i in range(1,6) %}
              <button type="button" class="star-btn" data-value="{{ i }}" aria-label="{{ i }} star{% if i>1 %}s{% endif %}">
                <svg class="star-icon icon-20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.402 8.172L12 18.896l-7.336 3.872 1.402-8.172L.132 9.21l8.2-1.192z"/></svg>
              </button>
              {% endfor %}
            </div>
            <input type="hidden" name="rating" id="rating-hidden" value="0" />
          </div>
          <input
            type="text"
            name="comment"
            placeholder="Write a comment..."
            required
          />
          <button class="btn btn-primary" type="submit" title="Submit comment">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 12.9999H9V10.9999H3V1.84558C3 1.56944 3.22386 1.34558 3.5 1.34558C3.58425 1.34558 3.66714 1.36687 3.74096 1.40747L22.2034 11.5618C22.4454 11.6949 22.5337 11.9989 22.4006 12.2409C22.3549 12.324 22.2865 12.3924 22.2034 12.4381L3.74096 22.5924C3.499 22.7255 3.19497 22.6372 3.06189 22.3953C3.02129 22.3214 3 22.2386 3 22.1543V12.9999Z"></path></svg>
            <span class="sr-only">Submit comment</span>
          </button>
        </form>
        {% else %}
        <p class="comment-login"><a href="{{ url_for('login') }}">Login</a> to leave a review.</p>
        {% endif %}
        

        
        {% if product.comments %} 
          <div class="comments-list">
            {% for comment in product.comments %}
          <div class="comments" id="product-comment-{{ comment.id }}">
            <div class="user-id-info">
              <div class="artist-avatar">
                {{ comment.artist.name[0].upper() if comment.artist.name else
                'U' }}
              </div>
              <div class="artist-name">
                {% if comment.artist.id %}
                <a
                  href="{{ url_for('view_profile', user_id=comment.artist.id) }}"
                  class="post-username"
                  >{{ comment.artist.name }}</a
                >
                {% else %}
                <span class="post-username">{{ comment.artist.name }}</span>
                {% endif %}
                <p class="post-user-email">
                  {{ comment.artist.email }} - {{ comment.created_at }}
                </p>
              </div>
              {% if current_user.is_authenticated and current_user.id ==
              comment.artist.id %}
              <form action="{{ url_for('delete_product_comment', comment_id=comment.id) }}" method="POST" class="form-inline">
                <input type="hidden" name="anchor" value="product-{{ product.product_id }}-comments" />
                <button class="action-btn delete-btn" onclick="return confirm('Delete this comment?')" type="submit" title="Delete comment">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    width="24"
                    height="24"
                    fill="currentColor"
                  >
                    <path
                      d="M17 6H22V8H20V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V8H2V6H7V3C7 2.44772 7.44772 2 8 2H16C16.5523 2 17 2.44772 17 3V6ZM9 11V17H11V11H9ZM13 11V17H15V11H13ZM9 4V6H15V4H9Z"
                    ></path>
                  </svg>
                  <span class="sr-only">Delete comment</span>
                </button>
              </form>
              {% endif %}
            </div>
            {% set ur = product.ratings_map.get(comment.artist.id) if product.ratings_map else 0 %}
            {% if ur %}
            <div class="rating-display">
              {% for i in range(1,6) %}
                {% if i <= ur %}
                <svg class="star-icon icon-16 star--filled" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.402 8.172L12 18.896l-7.336 3.872 1.402-8.172L.132 9.21l8.2-1.192z"/></svg>
                {% else %}
                <svg class="star-icon icon-16 star--empty" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.402 8.172L12 18.896l-7.336 3.872 1.402-8.172L.132 9.21l8.2-1.192z"/></svg>
                {% endif %}
              {% endfor %}
            </div>
            {% endif %}
            <p class="comment-p">{{ comment.content }}</p>
            <div class="icon-set">
              <button
                class="say-aloud-btn"
                title="Say Aloud"
                type="button"
                data-comment="{{ comment.content|e }}"
                data-author="{{ comment.artist.name|e if comment.artist.name else '' }}"
                onclick="sayCommentFromEl(this)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="32"
                  height="32"
                  fill="#000000"
                  viewBox="0 0 256 256"
                >
                  <path
                    d="M168,32V224a8,8,0,0,1-12.91,6.31L85.25,176H40a16,16,0,0,1-16-16V96A16,16,0,0,1,40,80H85.25l69.84-54.31A8,8,0,0,1,168,32Zm32,64a8,8,0,0,0-8,8v48a8,8,0,0,0,16,0V104A8,8,0,0,0,200,96Zm32-16a8,8,0,0,0-8,8v80a8,8,0,0,0,16,0V88A8,8,0,0,0,232,80Z"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
          {% endfor %} 
        </div>
        {% endif %}

          <!-- Product Meta -->
          <div class="product-meta">
            <div class="meta-item">
              <div class="meta-label">Added on</div>
              <div class="meta-value">{{ product.created_at }}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Category</div>
              <div class="meta-value">Artwork</div>
            </div>
          </div>

          <!-- Artist Information -->
          <div class="product-artist">
            <div class="artist">
              <div class="artist-avatar">
                {{ product.artist.name[0].upper() }}
              </div>
              <div class="artist-info">
                <h3>{{ product.artist.name }}</h3>
                <p>Artisan</p>
              </div>
            </div>
            <div class="view-artisan-btn">
              <a
                href="{{url_for('view_profile', user_id=product.artist.id)}}"
                class="btn-secondary"
                >View Artisan</a
              >
            </div>
          </div>
          <div class="buttons">

          {% if current_user.is_authenticated and current_user.id ==
          product.artist_id %}
          <button
            class="btn btn-primary"
            onclick="openEditModal()"
            title="Edit Product"
            type="button"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.7279 9.57629L14.3137 8.16207L5 17.4758V18.89H6.41421L15.7279 9.57629ZM17.1421 8.16207L18.5563 6.74786L17.1421 5.33365L15.7279 6.74786L17.1421 8.16207ZM7.24264 20.89H3V16.6474L16.435 3.21233C16.8256 2.8218 17.4587 2.8218 17.8492 3.21233L20.6777 6.04075C21.0682 6.43128 21.0682 7.06444 20.6777 7.45497L7.24264 20.89Z"></path>
            </svg>
            Edit Product
          </button>
          {% elif current_user.is_authenticated and current_user.id !=
          product.artist_id %}
          <button
            class="btn btn-secondary"
            onclick="addToCart({{ product.product_id }})"
            data-product-id="{{ product.product_id }}"
            title="Add to Cart"
            type="button"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.00488 9H19.9433L20.4433 7H8.00488V5H21.7241C22.2764 5 22.7241 5.44772 22.7241 6C22.7241 6.08176 22.7141 6.16322 22.6942 6.24254L20.1942 16.2425C20.083 16.6877 19.683 17 19.2241 17H5.00488C4.4526 17 4.00488 16.5523 4.00488 16V4H2.00488V2H5.00488C5.55717 2 6.00488 2.44772 6.00488 3V9ZM6.00488 23C4.90031 23 4.00488 22.1046 4.00488 21C4.00488 19.8954 4.90031 19 6.00488 19C7.10945 19 8.00488 19.8954 8.00488 21C8.00488 22.1046 7.10945 23 6.00488 23ZM18.0049 23C16.9003 23 16.0049 22.1046 16.0049 21C16.0049 19.8954 16.9003 19 18.0049 19C19.1095 19 20.0049 19.8954 20.0049 21C20.0049 22.1046 19.1095 23 18.0049 23Z"></path></svg>
            Add to Cart
          </button>
          {% elif not current_user.is_authenticated %}
          <button
            class="btn btn-secondary"
            onclick="window.location.href='{{ url_for('login') }}?next={{ url_for('product_buy', product_id=product.product_id) }}'"
            title="Login to add to cart"
            type="button"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.00488 9H19.9433L20.4433 7H8.00488V5H21.7241C22.2764 5 22.7241 5.44772 22.7241 6C22.7241 6.08176 22.7141 6.16322 22.6942 6.24254L20.1942 16.2425C20.083 16.6877 19.683 17 19.2241 17H5.00488C4.4526 17 4.00488 16.5523 4.00488 16V4H2.00488V2H5.00488C5.55717 2 6.00488 2.44772 6.00488 3V9ZM6.00488 23C4.90031 23 4.00488 22.1046 4.00488 21C4.00488 19.8954 4.90031 19 6.00488 19C7.10945 19 8.00488 19.8954 8.00488 21C8.00488 22.1046 7.10945 23 6.00488 23ZM18.0049 23C16.9003 23 16.0049 22.1046 16.0049 21C16.0049 19.8954 16.9003 19 18.0049 19C19.1095 19 20.0049 19.8954 20.0049 21C20.0049 22.1046 19.1095 23 18.0049 23Z"></path></svg>
            </svg>
            Add to Cart
          </button>
          {% endif %}
          {% if current_user.id != product.artist_id %}
          <a
            href="javascript:void(0)"
            onclick="handlePurchase()"
            class="btn btn-primary"
            >Purchase</a
          >
          {% else %}
          <button
            class="btn btn-secondary btn-danger"
            onclick="if(confirm('Delete this product?')) window.location.href='{{ url_for('delete_posts', product_id=product.product_id) }}'"
            title="Delete Post"
          >
            Delete Product
          </button>
          {% endif %}
        </div>
        
          <div class="product-options">
            <button
              class="share-btn"
              onclick="copyToClipboard(window.location.host + '{{ url_for('product_buy', product_id=product.product_id) }}')"
              title="Share Product"
              type="button"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                width="24"
                height="24"
                fill="currentColor"
              >
                <path
                  d="M13 14H11C7.54202 14 4.53953 15.9502 3.03239 18.8107C3.01093 18.5433 3 18.2729 3 18C3 12.4772 7.47715 8 13 8V3L23 11L13 19V14Z"
                ></path>
              </svg>
            </button>
            <button
              class="btn icon say-aloud-btn"
              title="Say Aloud"
              type="button"
              data-title="{{ product.title|e }}"
              data-artist="{{ product.artist.name|e }}"
              data-price="{{ product.price|string|e }}"
              data-description="{{ product.description|default('No description available')|e }}"
              onclick="sayAloudFromEl(this)"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="32"
                height="32"
                fill="#000000"
                viewBox="0 0 256 256"
              >
                <path
                  d="M168,32V224a8,8,0,0,1-12.91,6.31L85.25,176H40a16,16,0,0,1-16-16V96A16,16,0,0,1,40,80H85.25l69.84-54.31A8,8,0,0,1,168,32Zm32,64a8,8,0,0,0-8,8v48a8,8,0,0,0,16,0V104A8,8,0,0,0,200,96Zm32-16a8,8,0,0,0-8,8v80a8,8,0,0,0,16,0V88A8,8,0,0,0,232,80Z"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="google_translate_element" class="translate-element"></div>
    <button
      id="translateButton"
      onclick="googleTranslateElementInit()"
      class="translate-btn"
      title="Translate page"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
      >
        <path
          d="M18.5 10L22.9 21H20.745L19.544 18H15.454L14.255 21H12.101L16.5 10H18.5ZM10 2V4H16V6L14.0322 6.0006C13.2425 8.36616 11.9988 10.5057 10.4115 12.301C11.1344 12.9457 11.917 13.5176 12.7475 14.0079L11.9969 15.8855C10.9237 15.2781 9.91944 14.5524 8.99961 13.7249C7.21403 15.332 5.10914 16.5553 2.79891 17.2734L2.26257 15.3442C4.2385 14.7203 6.04543 13.6737 7.59042 12.3021C6.46277 11.0281 5.50873 9.57985 4.76742 8.00028L7.00684 8.00037C7.57018 9.03885 8.23979 10.0033 8.99967 10.877C10.2283 9.46508 11.2205 7.81616 11.9095 6.00101L2 6V4H8V2H10ZM17.5 12.8852L16.253 16H18.745L17.5 12.8852Z"
        ></path>
      </svg>
      <span class="sr-only">Translate this page</span>
    </button>

    <script>
      function toggleMenu(e) {
        e?.stopPropagation?.();
        const menu = document.getElementById("mobileMenu");
        const now = menu.style.display === "flex" ? "none" : "flex";
        menu.style.display = now;
        if (now === "flex")
          document.getElementById("searchBelow").classList.remove("open");
      }

      document.addEventListener("DOMContentLoaded", function () {
        const path = window.location.pathname.split("/").pop();
        document
          .querySelectorAll(".nav-center a, .mobile-menu a")
          .forEach((link) => {
            if (link.getAttribute("href") === path) {
              link.classList.add("active");
            } else {
              link.classList.remove("active");
            }
          });
      });

      function handlePurchase() {
        // Show a modal or redirect to payment gateway
        alert(
          "Payment gateway integration would go here!\n\nThis would typically redirect to:\n- Stripe\n- PayPal\n- Razorpay\n- Or other payment processors"
        );
      }

      function sayAloud(text) {
        const message = new SpeechSynthesisUtterance();
        message.text = `The title of the artwork is ${text.title}. It is created by ${text.artist}. The price of the artwork is Rs.${text.price}. The description says it is ${text.description}.`;
        window.speechSynthesis.speak(message); // Start speaking
      }

      async function copyToClipboard(textToCopy) {
        try {
          await navigator.clipboard.writeText(textToCopy);
          alert("Text copied to clipboard");
        } catch (err) {
          alert("Failed to copy text: " + err);
        }
      }
      function sayAloudFromEl(el) {
        const title = el.getAttribute("data-title") || "";
        const artist = el.getAttribute("data-artist") || "";
        const price = el.getAttribute("data-price") || "";
        const description = el.getAttribute("data-description") || "";
        const message = new SpeechSynthesisUtterance();
        message.text = `The title of the artwork is ${title}. It is created by ${artist}. The price of the artwork is Rs.${price}. The description says: ${description}.`;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(message);
      }
      // Speak a specific comment provided by data attributes on the element
      function sayCommentFromEl(el) {
        const text = el.getAttribute("data-comment") || "";
        const author = el.getAttribute("data-author") || "";
        if (!text) return;
        const msg = new SpeechSynthesisUtterance();
        msg.text = author ? `${author} says: ${text}` : text;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(msg);
      }

      // Cart functionality
      async function addToCart(productId) {
        const button = document.querySelector(
          `[data-product-id="${productId}"]`
        );
        const originalText = button.innerHTML;

        // Show loading state
        button.disabled = true;
        button.innerHTML = '<div class="loading"></div> Adding...';

        try {
          const response = await fetch(`/cart/add/${productId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (data.success) {
            // Show success message
            showCartMessage("Product added to cart!", "success");
            // Update cart count
            updateCartCount();
            // Reset button
            button.innerHTML = "âœ“ Added to Cart";
            button.style.background = "#28a745";
            setTimeout(() => {
              button.innerHTML = originalText;
              button.style.background = "";
              button.disabled = false;
            }, 2000);
          } else {
            throw new Error(data.message || "Failed to add to cart");
          }
        } catch (error) {
          console.error("Error adding to cart:", error);
          showCartMessage("Failed to add to cart", "error");
          button.innerHTML = originalText;
          button.disabled = false;
        }
      }

      async function updateCartCount() {
        try {
          const response = await fetch("/api/cart/count");
          const data = await response.json();
          document.getElementById("cartCount").textContent = data.count;
        } catch (error) {
          console.error("Error updating cart count:", error);
        }
      }

      function showCartMessage(message, type) {
        // Remove existing message
        const existingMessage = document.querySelector(".cart-message");
        if (existingMessage) {
          existingMessage.remove();
        }

        // Create new message
        const messageEl = document.createElement("div");
        messageEl.className = `cart-message ${type}`;
        messageEl.textContent = message;
        document.body.appendChild(messageEl);

        // Show message
        setTimeout(() => messageEl.classList.add("show"), 100);

        // Hide message after 3 seconds
        setTimeout(() => {
          messageEl.classList.remove("show");
          setTimeout(() => messageEl.remove(), 300);
        }, 3000);
      }

      // Update cart count on page load
      document.addEventListener("DOMContentLoaded", function () {
        updateCartCount();
        initCommentRatingWidget();
      });
    </script>
    <script
      type="text/javascript"
      src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"
    ></script>
    <script type="text/javascript">
      function googleTranslateElementInit() {
        new google.translate.TranslateElement(
          {
            pageLanguage: "en", // Set your website's default language
            includedLanguages:
              "en,hi,bi,ta,te,mr,gu,kn,ml,pa,ur,es,fr,de,zh,ja,ko", // Optional: Specify languages to include in the dropdown
            layout: google.translate.TranslateElement.InlineLayout.SIMPLE, // Optional: Customize widget layout
          },
          "google_translate_element"
        );
      }
    </script>
    <script>
      function initCommentRatingWidget() {
        const wrap = document.getElementById('comment-rating');
        if (!wrap) return;
        const hidden = document.getElementById('rating-hidden');
        const stars = wrap.querySelectorAll('.star-btn');
        const current = parseInt(wrap.getAttribute('data-current-rating') || '0', 10) || 0;
        function paint(n) {
          stars.forEach(btn => {
            const v = parseInt(btn.getAttribute('data-value'), 10) || 0;
            btn.classList.toggle('active', v <= n);
          });
        }
        if (current) {
          hidden.value = String(current);
          paint(current);
        }
        stars.forEach(btn => {
          btn.addEventListener('mouseover', () => paint(parseInt(btn.getAttribute('data-value'), 10) || 0));
          btn.addEventListener('focus', () => paint(parseInt(btn.getAttribute('data-value'), 10) || 0));
          btn.addEventListener('click', () => {
            const val = parseInt(btn.getAttribute('data-value'), 10) || 0;
            hidden.value = String(val);
            paint(val);
          });
        });
        wrap.addEventListener('mouseleave', () => paint(parseInt(hidden.value || '0', 10) || 0));
      }
    </script>

    <!-- Edit Product Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Product</h2>
          <span class="close-modal" onclick="closeEditModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="editProductForm" enctype="multipart/form-data">
            <div class="form-group">
              <label for="edit_product_name" class="form-label">Product Name</label>
              <input
                type="text"
                id="edit_product_name"
                name="product_name"
                class="form-input"
                value="{{ product.title }}"
                required
              />
            </div>

            <div class="form-group">
              <label for="edit_price" class="form-label">Price (Rs.)</label>
              <input
                type="number"
                id="edit_price"
                name="price"
                class="form-input"
                step="0.01"
                min="0"
                value="{{ product.price }}"
                required
              />
            </div>

            <div class="form-group">
              <label for="edit_description" class="form-label">Description</label>
              <textarea
                id="edit_description"
                name="description"
                class="form-textarea"
                rows="4"
              >{{ product.description }}</textarea>
            </div>

            <div class="form-group">
              <label for="edit_product_image" class="form-label">New Image (Optional)</label>
              <input
                type="file"
                id="edit_product_image"
                name="product_image_file"
                class="form-input"
                accept="image/*"
              />
              {% if product.img_url %}
              <div class="current-image">
                <img src="{{ product.img_url }}" alt="Current product image" class="current-image-preview">
                <small class="form-help">Current image</small>
              </div>
              {% endif %}
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <style>
      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        position: relative;
        background-color: #fff;
        margin: 50px auto;
        padding: 0;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e5e5e5;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
      }

      .modal-body {
        padding: 20px;
      }

      .close-modal {
        font-size: 24px;
        font-weight: bold;
        color: #666;
        cursor: pointer;
      }

      .close-modal:hover {
        color: #000;
      }

      /* Form styles */
      .modal .form-group {
        margin-bottom: 1rem;
      }

      .modal .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .modal .form-input,
      .modal .form-textarea {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
      }

      .modal .form-textarea {
        resize: vertical;
        min-height: 100px;
      }

      .modal .form-actions {
        margin-top: 1.5rem;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
      }

      .modal .current-image {
        margin: 1rem 0;
      }

      /* Loading indicator */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <script>
      // Modal functions
      function openEditModal() {
        document.getElementById('editModal').style.display = 'block';
      }

      function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
      }

      // Close modal when clicking outside
      window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target == modal) {
          closeEditModal();
        }
      }

      // Handle form submission
      document.getElementById('editProductForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const form = e.target;
        const formData = new FormData(form);
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="loading-spinner"></div> Saving...';

        try {
          const response = await fetch('{{ url_for("add_products", product_id=product.product_id) }}', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
          });

          const data = await response.json();

          if (data.success) {
            // Update product details in the page
            const productData = data.product;
            document.querySelector('.product-title').textContent = productData.title;
            document.querySelector('.product-price').textContent = 'Rs.' + productData.price;
            document.querySelector('.item-desc').textContent = productData.description;
            
            // Show success message
            showCartMessage('Product updated successfully!', 'success');
            
            // If a new image was uploaded and returned
            if (productData.img_url) {
              const imgElements = document.querySelectorAll('.product-image');
              imgElements.forEach(img => {
                img.src = productData.img_url;
              });
            }
            
            // Close modal
            closeEditModal();
          } else {
            throw new Error(data.message || 'Failed to update product');
          }
        } catch (error) {
          console.error('Error:', error);
          showCartMessage(error.message || 'Failed to update product', 'error');
          
          // Reset button state
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      });
    </script>
  </body>
</html>

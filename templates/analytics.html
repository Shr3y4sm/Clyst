<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Analytics â€¢ Clyst</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../static/css/styles.css" />
    <style>
      .page {
        max-width: 1100px;
        margin: 20px auto 40px;
        padding: 0 16px;
      }
      .title {
        font-size: 36px;
        font-weight: 500;
        color: var(--text);
      }
      .muted {
        color: var(--muted);
      }

      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-top: 16px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 16px;
      }
      .charts .card{
        padding: 0;
      }
      .kpi .label {
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .kpi .value {
        font-size: 32px;
        font-weight: 500;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
      }
      .list li {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
      }
      .list li:last-child {
        border-bottom: 0;
      }

      .chart {
        height: 260px;
        max-height: 260px;
        display: block;
        width: 100%;
      }
      .apexcharts-canvas {
        width: 100% !important;
      }
      .legend {
        display: flex;
        gap: 12px;
        font-size: 12px;
        color: var(--muted);
        margin-top: 8px;
      }
      .legend span {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .legend i {
        width: 10px;
        height: 10px;
        display: inline-block;
        border-radius: 2px;
      }
      .legend .pv {
        background: var(--accent);
      }
      .legend .pr {
        background: #4db6ac;
      }

      .insight-card{
        overflow: hidden;
        padding: 0;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 24px;
        font-weight: 500;
        color: var(--text);
        margin-bottom: 0;
      }

      .insight-card .section-title{
        padding: 12px 16px;
        background-color: var(--border);
      }

      .charts .section-title{
        margin: 20px 20px 0 20px;
        font-size: 28px;
        font-weight: 500;
      }

      .sub {
        font-size: 15px;
        color: var(--muted);
        margin: 0 20px 20px 20px;
      }

      /* Tab styles */
      .tab-nav {
        display: flex;
        gap: 0;
      }
      .tab-btn {
        background: transparent;
        border: none;
        padding: 12px;
        font-size: 14px;
        font-weight: 500;
        color: var(--muted);
        cursor: pointer;
        border-bottom: none;
        transition: all 0.2s;
        border-radius: 20em;
      }
      .tab-btn:hover {
        color: var(--text);
      }
      .tab-btn.active {
        background-color: var(--border);
        color: var(--accent);
      }
      .tab-content {
        margin-top: 16px;
      }

      /* Insights styles */
      .insight-list {
        list-style: none;
        padding: 0;
      }
      .insight-list li {
        font-size: 16px;
        padding: 12px 16px;
        border-top: 1px solid var(--border);
        line-height: 1.1;
        color: var(--text);
      }
      .insight-list li:before {
        color: var(--accent);
        font-weight: bold;
        display: inline-block;
        width: 1em;
        margin-left: -1em;
        margin-right: 0.5em;
      }
      .charts{
        grid-template-columns: 1fr;
      }
      .charts svg{
        max-width: 100%;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 900px) {
        .kpi-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .grid-2 {
          grid-template-columns: 1fr;
        }
        .tab-btn {
          font-size: 13px;
          padding: 10px 14px;
        }
      }
    </style>
  </head>
  <body>
    <!-- top nav reuse -->
    <nav id="topNav" style="position: sticky; top: 0">
      <div class="nav">
        <div class="nav-left">
          <a
            href="{{ url_for('home') }}"
            style="text-decoration: none; color: inherit"
            >Clyst</a
          >
        </div>
        <div class="nav-center" id="navLinks">
          <a href="{{ url_for('home') }}">Community Feed</a>
          <a href="{{ url_for('products_page') }}">Marketplace</a>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
        <a href="{{ url_for('login') }}">Login</a>
        <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
        </div>
        
      <div class="nav-actions">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('profile') }}" class="profile-btn" title="Profile">
           <svg width="100%" height="100%" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M28.8662 27.5C28.7784 27.652 28.6521 27.7783 28.5001 27.8661C28.348 27.9538 28.1755 28 28 28H3.99995C3.8245 27.9998 3.65219 27.9535 3.50031 27.8656C3.34843 27.7778 3.22234 27.6515 3.13469 27.4995C3.04705 27.3475 3.00093 27.1752 3.00098 26.9997C3.00102 26.8243 3.04723 26.6519 3.13495 26.5C5.0387 23.2087 7.97245 20.8487 11.3962 19.73C9.70266 18.7218 8.38688 17.1856 7.65094 15.3572C6.91499 13.5289 6.79956 11.5095 7.32238 9.60918C7.8452 7.70887 8.97735 6.03272 10.545 4.83814C12.1126 3.64355 14.029 2.99658 16 2.99658C17.9709 2.99658 19.8873 3.64355 21.4549 4.83814C23.0226 6.03272 24.1547 7.70887 24.6775 9.60918C25.2003 11.5095 25.0849 13.5289 24.349 15.3572C23.613 17.1856 22.2972 18.7218 20.6037 19.73C24.0275 20.8487 26.9612 23.2087 28.865 26.5C28.9529 26.6519 28.9993 26.8243 28.9996 26.9998C28.9998 27.1754 28.9538 27.3479 28.8662 27.5Z" fill="inherit"/></svg>
        </a>
        {% endif %}
      </div>
      </div>
    </nav>

    <div class="page">
      <div>
        <div class="title">Your Analytics</div>
        <div class="muted">Private dashboard only visible to you.</div>
      </div>

      <!-- Tab Navigation -->
      <div
        class="tab-nav"
        style="padding: 4px;overflow: hidden;background: var(--card);border-radius: 20em;width: fit-content;margin: 20px 0; border-bottom: none;"
      >
        <button class="tab-btn active" data-tab="overview">Overview</button>
        <button class="tab-btn" data-tab="insights">AI Insights</button>
      </div>

      <!-- Overview Tab Content -->
      <div id="overview-tab" class="tab-content active">
        <div class="kpi-grid">
          <div class="card kpi">
            <div class="label">Views</div>
            <div class="value">{{ kpis.views }}</div>
          </div>
          <div class="card kpi">
            <div class="label">Engagement</div>
            <div class="value">{{ kpis.engagement }}</div>
          </div>
          <div class="card kpi">
            <div class="label">Items Sold</div>
            <div class="value">{{ kpis.sales }}</div>
          </div>
          <div class="card kpi">
            <div class="label">Revenue</div>
            <div class="value">â‚¹ {{ '%.2f'|format(kpis.revenue) }}</div>
          </div>
        </div>

        <div class="grid-2 charts">
          <div class="card">
            <div class="section-title">Views &#0149; Last 30 days</div>
              <div id="viewsChart" style="height: 260px; width: 100%; display: block;"></div>
          </div>
          <div class="card">
            <div class="section-title">Revenue &#0149; Last 30 days</div>
            <div id="revenueChart" style="height: 260px; width: 100%; display: block;"></div>
            <div class="sub">
              Orders: {{ total_orders }} â€¢ Gross: â‚¹ {{
              '%.2f'|format(total_revenue) }} â€¢ Paid: â‚¹ {{
              '%.2f'|format(paid_revenue) }}
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="section-title">Top Products by Views</div>
            <ul class="list">
              {% for p in top_products_by_views %}
              <li><span>{{ p.title }}</span><span>{{ p.count }}</span></li>
              {% else %}
              <li class="muted">No data yet.</li>
              {% endfor %}
            </ul>
          </div>
          <div class="card">
            <div class="section-title">Top Products by Sales</div>
            <ul class="list">
              {% for p in top_products_by_sales %}
              <li><span>{{ p.title }}</span><span>{{ p.count }}</span></li>
              {% else %}
              <li class="muted">No data yet.</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <div class="card" style="margin-top: 12px">
          <div class="section-title">Top Posts by Engagement</div>
          <ul class="list">
            {% for p in top_posts_by_engagement %}
            <li><span>{{ p.title }}</span><span>{{ p.score }}</span></li>
            {% else %}
            <li class="muted">No posts yet.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      <!-- End Overview Tab -->

      <!-- Insights Tab Content -->
      <div id="insights-tab" class="tab-content" style="display: none">
        <div class="insights-loading" style="text-align: center; padding: 40px">
          <div
            class="spinner"
            style="
              border: 4px solid var(--border);
              border-top-color: var(--accent);
              border-radius: 50%;
              width: 40px;
              height: 40px;
              animation: spin 1s linear infinite;
              margin: 0 auto 16px;
            "
          ></div>
          <div class="muted">Generating AI insights for your business...</div>
        </div>

        <div class="insights-content" style="display: none">
          <div
            class="insights-intro card"
            style="
              margin-bottom: 12px;
              background: none;
              color: var(--text);
              border: none;
              padding: 0;
            "
          >
            <div style="font-size: 18px; font-weight: 500; display: flex; align-items: center; gap: 8px; margin: 0 0 4px 0;">
              <svg style="width: 20px; fill: var(--text);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.0007 1.20825 18.3195 3.68108 20.7923 4.99992 18.3195 6.31876 17.0007 8.79159 15.6818 6.31876 13.209 4.99992 15.6818 3.68108 17.0007 1.20825ZM8.00065 4.33325 10.6673 9.33325 15.6673 11.9999 10.6673 14.6666 8.00065 19.6666 5.33398 14.6666.333984 11.9999 5.33398 9.33325 8.00065 4.33325ZM19.6673 16.3333 18.0007 13.2083 16.334 16.3333 13.209 17.9999 16.334 19.6666 18.0007 22.7916 19.6673 19.6666 22.7923 17.9999 19.6673 16.3333Z"></path></svg> AI-Powered Insights
            </div>
            <div style="opacity: 0.95">
              Personalized recommendations based on your products, posts, and
              customer engagement.
            </div>
          </div>

          <div class="grid-2">
            <div class="card insight-card" style="border-color: var(--accent);">
              <div class="section-title" style="color: var(--accent); background-color: var(--border);">
               Product Optimization
              </div>
              <ul class="insight-list" id="product-insights"></ul>
            </div>
            <div class="card insight-card" style="border-color: #00b4d8;">
              <div class="section-title" style="color: #00b4d8; background-color: #00b4d821;">
                Marketing Strategy
              </div>
              <ul class="insight-list" id="marketing-insights"></ul>
            </div>
          </div>

          <div class="grid-2" style="margin-top: 12px">
            <div class="card insight-card" style="border-color: #02c39a;">
              <div class="section-title" style="color: #02c39a; background-color: #02c39a21;">
                Pricing Strategy
              </div>
              <ul class="insight-list" id="pricing-insights"></ul>
            </div>
            <div class="card insight-card" style="border-color: #ff7b00;">
              <div class="section-title" style="color: #ff7b00; background-color: #ff7b0021;">
                Growth Opportunities
              </div>
              <ul class="insight-list" id="growth-insights"></ul>
            </div>
          </div>

          <!-- Competitive Pricing Analysis Section -->
          <div
            class="card"
            style="margin-top: 20px; border: 1px solid var(--accent)"
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0px;
                flex-wrap: wrap;
                gap: 12px;
              "
            >
              <div style="flex: 1; min-width: 250px">
                <div
                  class="section-title"
                  style="color: var(--accent); font-size: 18px"
                >
                  <svg style="width: 20px; fill: var(--accent);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12ZM22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12ZM13.5003 8C13.8278 8.43606 14.0625 8.94584 14.175 9.5H16V11H14.175C13.8275 12.7117 12.3142 14 10.5 14H10.3107L14.0303 17.7197L12.9697 18.7803L8 13.8107V12.5H10.5C11.4797 12.5 12.3131 11.8739 12.622 11H8V9.5H12.622C12.3131 8.62611 11.4797 8 10.5 8H8V6.5H16V8H13.5003Z"></path></svg>AI-Powered Competitive Pricing
                </div>
                <div class="muted" style="font-size: 13px; margin-top: 4px">
                  AI finds truly similar products (not just similar prices)
                </div>
              </div>
              <div
                style="
                  display: flex;
                  gap: 8px;
                  align-items: center;
                  flex-wrap: wrap;
                "
              >
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    font-size: 13px;
                    cursor: pointer;
                    padding: 6px 12px 6px 8px;
                    border-radius: 4px;
                    border: 1px solid var(--border);
                  "
                >
                  <input
                    type="checkbox"
                    id="include-external"
                    style="
                      cursor: pointer;
                      width: 16px;
                      height: 16px;
                    "
                  />
                  <span style="color: var(--text)"
                    >Include Amazon, Etsy, Flipkart</span
                  >
                </label>
                <button
                  id="load-pricing-btn"
                  onclick="loadCompetitivePricing()"
                  style="
                  display: flex;
                  align-items: center;
                  gap: 8px;
                    padding: 4px 12px;
                    background: var(--accent);
                    color: var(--card);
                    border: none;
                    border-radius: 2px;
                    cursor: pointer;
                    font-weight: 500;
                    font-size: 13px;
                  "
                >
                  <svg style="width: 20px; fill: var(--card);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10.6144 17.7956 11.492 15.7854C12.2731 13.9966 13.6789 12.5726 15.4325 11.7942L17.8482 10.7219C18.6162 10.381 18.6162 9.26368 17.8482 8.92277L15.5079 7.88394C13.7092 7.08552 12.2782 5.60881 11.5105 3.75894L10.6215 1.61673C10.2916.821765 9.19319.821767 8.8633 1.61673L7.97427 3.75892C7.20657 5.60881 5.77553 7.08552 3.97685 7.88394L1.63658 8.92277C.868537 9.26368.868536 10.381 1.63658 10.7219L4.0523 11.7942C5.80589 12.5726 7.21171 13.9966 7.99275 15.7854L8.8704 17.7956C9.20776 18.5682 10.277 18.5682 10.6144 17.7956ZM19.4014 22.6899 19.6482 22.1242C20.0882 21.1156 20.8807 20.3125 21.8695 19.8732L22.6299 19.5353C23.0412 19.3526 23.0412 18.7549 22.6299 18.5722L21.9121 18.2532C20.8978 17.8026 20.0911 16.9698 19.6586 15.9269L19.4052 15.3156C19.2285 14.8896 18.6395 14.8896 18.4628 15.3156L18.2094 15.9269C17.777 16.9698 16.9703 17.8026 15.956 18.2532L15.2381 18.5722C14.8269 18.7549 14.8269 19.3526 15.2381 19.5353L15.9985 19.8732C16.9874 20.3125 17.7798 21.1156 18.2198 22.1242L18.4667 22.6899C18.6473 23.104 19.2207 23.104 19.4014 22.6899Z"></path></svg> Analyze with AI
                </button>
              </div>
            </div>

            <div
              id="pricing-loading"
              style="display: none; text-align: center; padding: 30px"
            >
              <div
                class="spinner"
                style="
                  border: 4px solid var(--border);
                  border-top-color: var(--accent);
                  border-radius: 50%;
                  width: 30px;
                  height: 30px;
                  animation: spin 1s linear infinite;
                  margin: 0 auto 12px;
                "
              ></div>
              <div class="muted">Analyzing market pricing...</div>
            </div>

            <div id="pricing-content" style="display: none">
              <!-- Pricing Stats -->
              <div class="grid-2" style="gap: 12px; margin-bottom: 16px">
                <div
                  style="
                    border: 1px solid var(--border);
                    background: none;
                    padding: 16px;
                    border-radius: 16px;
                    color: var(--muted);
                  "
                >
                  <div
                    style="
                      font-size: 12px;
                      text-transform: uppercase;
                      letter-spacing: 0.04em;
                    "
                  >
                    Your Average Price
                  </div>
                  <div
                    style="font-size: 28px; font-weight: 500; margin-top: 4px; color: var(--text);"
                  >
                    â‚¹<span id="your-avg-price">0</span>
                  </div>
                  <div style="font-size: 12px; margin-top: 4px">
                    Range: â‚¹<span id="your-min-price">0</span> - â‚¹<span
                      id="your-max-price"
                      >0</span
                    >
                  </div>
                </div>
                <div
                  style="
                    border: 1px solid var(--border);
                    background: none;
                    padding: 16px;
                    border-radius: 16px;
                  "
                >
                  <div
                    style="
                      font-size: 12px;
                      color: var(--muted);
                      text-transform: uppercase;
                      letter-spacing: 0.04em;
                    "
                  >
                    Market Average Price
                  </div>
                  <div
                    style="
                      font-size: 28px;
                      font-weight: 500;
                      margin-top: 4px;
                      color: var(--text);
                    "
                  >
                    â‚¹<span id="market-avg-price">0</span>
                  </div>
                  <div
                    style="
                      font-size: 12px;
                      color: var(--muted);
                      margin-top: 4px;
                    "
                  >
                    Median: â‚¹<span id="market-median-price">0</span>
                  </div>
                </div>
              </div>

              <!-- Price Positioning -->
              <div
                class="card"
                style="background: none; margin-bottom: 16px"
              >
                <div style="display: flex; align-items: center; gap: 12px">
                  <div style="display: flex;font-size: 32px;align-items: center;"><svg style="width: 40px; fill: var(--text);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.80577 5.20006L7.00505 7.99958L11.1913 2.13881C11.5123 1.6894 12.1369 1.58531 12.5863 1.90631C12.6761 1.97045 12.7546 2.04901 12.8188 2.13881L17.0051 7.99958L21.2043 5.20006C21.6639 4.89371 22.2847 5.01788 22.5911 5.47741C22.7228 5.67503 22.7799 5.91308 22.7522 6.14895L21.109 20.1164C21.0497 20.62 20.6229 20.9996 20.1158 20.9996H3.8943C3.38722 20.9996 2.9604 20.62 2.90115 20.1164L1.25792 6.14895C1.19339 5.60045 1.58573 5.10349 2.13423 5.03896C2.37011 5.01121 2.60816 5.06832 2.80577 5.20006ZM12.0051 14.9996C13.1096 14.9996 14.0051 14.1042 14.0051 12.9996C14.0051 11.895 13.1096 10.9996 12.0051 10.9996C10.9005 10.9996 10.0051 11.895 10.0051 12.9996C10.0051 14.1042 10.9005 14.9996 12.0051 14.9996Z"></path></svg></div>
                  <div style="flex: 1">
                    <div
                      style="
                        font-weight: 500;
                        font-size: 16px;
                        color: var(--text);
                      "
                      id="position-label"
                    >
                      Analyzing...
                    </div>
                    <div
                      style="
                        font-size: 13px;
                        color: var(--muted);
                        margin-top: 4px;
                        line-height: 1.5;
                      "
                      id="position-advice"
                    >
                      Please wait...
                    </div>
                  </div>
                  <div style="text-align: center">
                    <div
                      style="
                        font-size: 28px;
                        font-weight: 500;
                        color: var(--accent);
                      "
                      id="price-diff"
                    >
                      0%
                    </div>
                    <div style="font-size: 11px; color: var(--muted)">
                      vs Market
                    </div>
                  </div>
                </div>
              </div>

              <!-- Similar Products -->
              <div>
                <div class="section-title" style="margin-bottom: 12px">
                  Similar Products in Marketplace
                </div>
                <div
                  id="similar-products-grid"
                  style="
                    display: grid;
                    grid-template-columns: repeat(
                      auto-fill,
                      minmax(250px, 1fr)
                    );
                    gap: 12px;
                  "
                >
                  <!-- Products will be inserted here -->
                </div>
                <div
                  id="no-similar-products"
                  style="
                    display: none;
                    text-align: center;
                    padding: 30px;
                    color: var(--muted);
                  "
                >
                  No similar products found in the marketplace.
                </div>
              </div>
            </div>

            <div
              id="pricing-error"
              style="display: none; text-align: center; padding: 30px"
            >
              <div style="font-size: 32px; margin-bottom: 12px; fill: var(--text);"><svg style="width: 40px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 15H13V17H11V15ZM11 7H13V13H11V7Z"></path></svg></div>
              <div class="muted" id="pricing-error-message"></div>
              <button
                onclick="loadCompetitivePricing()"
                style="
                  margin-top: 12px;
                  padding: 8px 16px;
                  background: var(--accent);
                  color: var(--card);
                  border: none;
                  border-radius: 20em;
                  cursor: pointer;
                  font-weight: 500;
                "
              >
                Try Again
              </button>
            </div>
          </div>
        </div>

        <div
          class="insights-error card"
          style="display: none; text-align: center; padding: 40px"
        >
          <div style="font-size: 32px; margin-bottom: 12px; fill: var(--text);"><svg style="max-width: 80px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 15H13V17H11V15ZM11 7H13V13H11V7Z"></path></svg></div>
              <div class="section-title" style="text-align: center; justify-content: center;">Failed to Generate Insights</div>
          <div class="muted" id="error-message" style="margin-top: 8px"></div>
          <button
            onclick="loadInsights()"
            style="
              margin-top: 16px;
              padding: 10px 20px;
              background: var(--accent);
              color: var(--card);
              border: none;
              border-radius: 20em;
              cursor: pointer;
              font-weight: 500;
            "
          >
            Try Again
          </button>
        </div>
      </div>
      <!-- End Insights Tab -->
    </div>

    <!-- charts powered by ApexCharts -->
    <script src="https://unpkg.com/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
    <script>
      const days = {{ days|tojson }};
      const pv = {{ product_views_daily|tojson }};
      const pr = {{ profile_views_daily|tojson }};
      const rev = {{ revenue_daily|tojson }};

      // Read CSS variables for consistent coloring (sanitize project's light-dark placeholders)
      const css = getComputedStyle(document.documentElement);
      const _rawAccent = (css.getPropertyValue('--accent') || '').trim();
      const _rawMuted = (css.getPropertyValue('--muted') || '').trim();
      const _rawText = (css.getPropertyValue('--text') || '').trim();
      const _rawBorder = (css.getPropertyValue('--border') || '').trim();
      function cleanColor(raw, fallback) {
        if (!raw) return fallback;
        // project uses a `light-dark(...)` placeholder which isn't a valid CSS color at runtime
        if (raw.indexOf('light-dark') !== -1) return fallback;
        return raw;
      }
      const accent = cleanColor(_rawAccent, '#ff7b00');
      const mutedColor = cleanColor(_rawMuted, '#888');
      const textColor = cleanColor(_rawText, '#fff');
      const borderColor = cleanColor(_rawBorder, 'rgba(255,255,255,0.1)');
      const green = '#00b4d8';
      const purple = '#00b4d8';

      // Format days for x-axis: show `Mon dd` (e.g. "Oct 15")
      const formattedDays = (Array.isArray(days) ? days : []).map(d => {
        const dt = new Date(d);
        if (isNaN(dt)) return String(d);
        return dt.toLocaleString('en-US', { month: 'short', day: 'numeric' });
      });

      // Debug logging removed in production

      // Small-data fallback: if all series are empty or zero, show a friendly message
      const allZero = arr => Array.isArray(arr) && arr.every(v => Number(v) === 0);
      const noDateLabels = !Array.isArray(formattedDays) || formattedDays.length === 0;

      if (noDateLabels || (allZero(pv) && allZero(pr) && allZero(rev))) {
        const msg = '<div style="padding:18px;color:var(--muted);">Not enough data to render charts yet.</div>';
        const vEl = document.getElementById('viewsChart');
        const rEl = document.getElementById('revenueChart');
        if (vEl) vEl.innerHTML = msg;
        if (rEl) rEl.innerHTML = msg;
      } else {
        // coerce data to numbers and provide fallbacks for colors
        const pvData = (pv || []).map(v => Number(v) || 0);
        const prData = (pr || []).map(v => Number(v) || 0);
        const revData = (rev || []).map(v => Number(v) || 0);

        const accentColor = (accent && accent.length) ? accent : '#ff7b00';
        const profileColor = green;

        // Views chart (line chart with two series)
        const showMarkers = (pvData.some(v => v > 0) || prData.some(v => v > 0));
        const viewsChartOptions = {
          series: [
            { name: 'Product views', data: pvData },
            { name: 'Profile views', data: prData }
          ],
          chart: { type: 'line', height: 260, toolbar: { show: false }, sparkline: { enabled: false }, fontFamily: 'Poppins, sans-serif'  },
          colors: [accentColor, profileColor],
          stroke: { width: 3, curve: 'smooth' },
          markers: { size: 0, strokeWidth: 0 },
          xaxis: { categories: formattedDays, labels: { show: false}, axisBorder: { show: false }, axisTicks: { show: false } },
          yaxis: { labels: { style: { colors: mutedColor } } },
          grid: { borderColor: borderColor },
          legend: { labels: { colors: mutedColor }, markers: {shape: "line"} , position: 'top', horizontalAlign: 'left', fontSize: '16px', itemMargin: {horizontal: 10} },
          tooltip: {
            theme: 'dark',
            shared: true,
            intersect: false,
            x: {
              formatter: function(value, { dataPointIndex }) {
                if (typeof dataPointIndex === 'number' && formattedDays[dataPointIndex]) return formattedDays[dataPointIndex];
                return value || '';
              }
            },
            y: { formatter: (val) => Math.round(val) }
          }
        };

        // Revenue chart (bar chart)
        const revenueChartOptions = {
          series: [{ name: 'Revenue', data: revData }],
          chart: { type: 'bar', height: 260, toolbar: { show: false }, sparkline: { enabled: false }, fontFamily: 'Poppins, sans-serif' },
          colors: [purple],
          plotOptions: { bar: { borderRadius: 6, columnWidth: '60%' } },
          dataLabels: { enabled: false },
          xaxis: { categories: formattedDays, labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } },
          yaxis: { labels: { style: { colors: mutedColor }, formatter: (val) => 'â‚¹' + Math.round(val) } },
          grid: { borderColor: borderColor },
          legend: { labels: { colors: mutedColor }, position: 'top' },
          tooltip: {
            theme: 'dark',
            x: {
              // Apex passes the category `value` and an options object; use dataPointIndex
              formatter: function(value, { dataPointIndex }) {
                if (typeof dataPointIndex === 'number' && formattedDays[dataPointIndex]) return formattedDays[dataPointIndex];
                // fallback to original value or a friendly empty string
                return value || '';
              }
            },
            y: { formatter: (val) => 'â‚¹' + val.toFixed(2) }
          }
        };

        // Render charts
        const viewsChart = new ApexCharts(document.getElementById('viewsChart'), viewsChartOptions);
        const revenueChart = new ApexCharts(document.getElementById('revenueChart'), revenueChartOptions);
        viewsChart.render();
        revenueChart.render();

        // Force charts to fill containers after render
        setTimeout(() => {
          document.querySelectorAll('.apexcharts-canvas').forEach(el => {
            el.style.width = '100%';
            el.style.maxWidth = '100%';
          });
        }, 100);
      }
    </script>

    <script>
      // Tab switching
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      let insightsLoaded = false;

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;

          // Update active states
          tabBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          // Show selected tab
          tabContents.forEach(content => {
            if (content.id === tab + '-tab') {
              content.style.display = 'block';
              // Load insights when tab is opened for the first time
              if (tab === 'insights' && !insightsLoaded) {
                loadInsights();
              }
            } else {
              content.style.display = 'none';
            }
          });
        });
      });

      // Load AI insights
      function loadInsights() {
        const loading = document.querySelector('.insights-loading');
        const content = document.querySelector('.insights-content');
        const error = document.querySelector('.insights-error');

        // Show loading state
        loading.style.display = 'block';
        content.style.display = 'none';
        error.style.display = 'none';

        fetch('/analytics/insights')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              insightsLoaded = true;
              displayInsights(data.insights);
              loading.style.display = 'none';
              content.style.display = 'block';
            } else {
              throw new Error(data.error || 'Failed to load insights');
            }
          })
          .catch(err => {
            loading.style.display = 'none';
            error.style.display = 'block';
            document.getElementById('error-message').textContent = err.message;
          });
      }

      // Display insights in the UI
      function displayInsights(insights) {
        const categories = [
          { key: 'product_optimization', elementId: 'product-insights' },
          { key: 'marketing_strategy', elementId: 'marketing-insights' },
          { key: 'pricing_strategy', elementId: 'pricing-insights' },
          { key: 'growth_opportunities', elementId: 'growth-insights' }
        ];

        categories.forEach(cat => {
          const list = document.getElementById(cat.elementId);
          const items = insights[cat.key] || [];

          if (items.length === 0) {
            list.innerHTML = '<li class="muted">No insights available for this category.</li>';
          } else {
            list.innerHTML = items.map(item => `<li>${item}</li>`).join('');
          }
        });
      }

      // Load competitive pricing analysis
      function loadCompetitivePricing() {
        const loading = document.getElementById('pricing-loading');
        const content = document.getElementById('pricing-content');
        const error = document.getElementById('pricing-error');
        const button = document.getElementById('load-pricing-btn');
        const includeExternal = document.getElementById('include-external').checked;

        // Show loading state
        loading.style.display = 'block';
        content.style.display = 'none';
        error.style.display = 'none';
        button.disabled = true;
        button.textContent = includeExternal ? 'AI Analyzing (with external sources)...' : 'AI Analyzing...';

        const url = '/analytics/competitive-pricing' + (includeExternal ? '?external=true' : '');

        fetch(url)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              displayPricingAnalysis(data.analysis, data.ai_powered);
              loading.style.display = 'none';
              content.style.display = 'block';
              button.style.display = 'none';
            } else {
              throw new Error(data.error || 'Failed to load pricing analysis');
            }
          })
          .catch(err => {
            loading.style.display = 'none';
            error.style.display = 'block';
            document.getElementById('pricing-error-message').textContent = err.message;
            button.disabled = false;
            button.textContent = 'ðŸ¤– Analyze with AI';
          });
      }

      // Display competitive pricing analysis
      function displayPricingAnalysis(analysis, aiPowered) {
        // Your products stats
        document.getElementById('your-avg-price').textContent = analysis.your_products.avg_price.toFixed(2);
        document.getElementById('your-min-price').textContent = analysis.your_products.min_price.toFixed(2);
        document.getElementById('your-max-price').textContent = analysis.your_products.max_price.toFixed(2);

        // Market stats
        document.getElementById('market-avg-price').textContent = analysis.market.avg_price.toFixed(2);
        document.getElementById('market-median-price').textContent = analysis.market.median_price.toFixed(2);

        // Positioning
        document.getElementById('position-label').textContent = analysis.positioning.label;
        document.getElementById('position-advice').textContent = analysis.positioning.advice;

        const diff = analysis.positioning.difference_percent;
        const diffElement = document.getElementById('price-diff');
        diffElement.textContent = (diff > 0 ? '+' : '') + diff.toFixed(1) + '%';
        diffElement.style.color = diff > 20 ? '#ff9800' : diff < -20 ? '#4db6ac' : 'var(--accent)';

        // Show external market data if available
        if (analysis.external_market) {
          const externalDiv = document.createElement('div');
          externalDiv.className = 'card';
          externalDiv.style.cssText = 'border: none; background: none; color: var(--text); margin-bottom: 16px; padding: 0;';
          externalDiv.innerHTML = `
            <div style="font-weight: 500; font-size: 28px; margin-bottom: 12px;">External Market Pricing</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; font-size: 20px;">
              <div style="display: flex; align-items:center; gap:12px; border: 1px solid var(--text); line-height: 1; border-radius: 12px; padding: 12px 24px;">
                <svg fill="var(--text)" style="height:fit-content;" height="200px" width="200px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="87 292.9 256 255.9" xml:space="preserve"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <style type="text/css"> .st0{display:none;} .st1{display:inline;} .st2{fill-rule:evenodd;clip-rule:evenodd;} </style> <g> <path class="st2" d="M306,500.1c-1.3,0-2.6,0.3-3.8,0.9c-1.4,0.6-2.8,1.2-4.1,1.7l-1.9,0.8l-2.5,1v0c-27.5,11.1-56.3,17.7-83,18.2 c-1,0-2,0-2.9,0c-42,0-76.2-19.5-110.8-38.6c-1.2-0.6-2.4-1-3.6-1c-1.6,0-3.1,0.6-4.3,1.7c-1.2,1.1-1.9,2.7-1.8,4.3 c0,2.1,1.1,4,2.7,5.3c32.4,28.2,68,54.3,115.8,54.4c0.9,0,1.9,0,2.8,0c30.4-0.7,64.8-11,91.5-27.7l0.2-0.1c3.5-2.1,7-4.5,10.3-7.1 c2-1.5,3.5-3.9,3.5-6.4C313.7,503.1,310,500.1,306,500.1z"></path> <path class="st2" d="M343,484.6L343,484.6c-0.1-2.7-0.7-4.7-1.8-6.4l-0.1-0.2l-0.1-0.2c-1.1-1.2-2.2-1.7-3.4-2.2 c-3.5-1.3-8.6-2.1-14.7-2.1c-4.4,0-9.3,0.4-14.2,1.5l0-0.3l-4.9,1.6l-0.1,0l-2.8,0.9v0.1c-3.3,1.4-6.2,3-9,5 c-1.7,1.3-3.1,3-3.2,5.6c0,1.4,0.7,3,1.9,4c1.2,1,2.6,1.3,3.8,1.3c0.3,0,0.6,0,0.8-0.1l0.2,0l0.2,0c2.4-0.5,5.9-0.8,10-1.4 c3.5-0.4,7.3-0.7,10.5-0.7c2.3,0,4.4,0.1,5.8,0.5c0.7,0.1,1.2,0.3,1.5,0.5c0.1,0,0.2,0.1,0.2,0.1c0.1,0.2,0.1,0.7,0.1,1.4 c0,2.7-1.1,7.7-2.7,12.6c-1.5,4.9-3.4,9.8-4.6,13.1c-0.3,0.8-0.5,1.6-0.5,2.5c0,1.3,0.5,2.9,1.6,4c1.1,1.1,2.6,1.5,3.8,1.5h0.1 c1.8,0,3.4-0.7,4.7-1.8c12.5-11.2,16.8-29.2,17-39.3L343,484.6z"></path> <path class="st2" d="M228.7,364.1c-7.3,0.6-15.8,1.1-24.3,2.2c-13,1.7-26,4-36.7,9.1c-20.9,8.5-35,26.5-35,53.1 c0,33.3,21.5,50.3,48.6,50.3c9,0,16.4-1.1,23.1-2.8c10.8-3.4,19.8-9.6,30.5-20.9c6.2,8.5,7.9,12.4,18.6,21.5 c2.8,1.1,5.7,1.1,7.9-0.6c6.8-5.7,18.7-15.8,24.9-21.5c2.8-2.3,2.3-5.7,0.6-8.5c-6.2-7.9-12.4-14.7-12.4-30v-50.8 c0-21.5,1.7-41.2-14.1-55.9c-13-11.9-33.3-16.4-49.2-16.4h-6.8c-28.8,1.7-59.3,14.1-66.1,49.7c-1.1,4.5,2.3,6.2,4.5,6.8l31.6,4 c3.4-0.6,5.1-3.4,5.6-6.2c2.8-12.4,13-18.7,24.3-19.8h2.3c6.8,0,14.1,2.8,18.1,8.5c4.5,6.8,4,15.8,4,23.7V364.1z M222.5,431.3 c-4,7.9-10.7,13-18.1,14.7c-1.1,0-2.8,0.6-4.5,0.6c-12.4,0-19.8-9.6-19.8-23.7c0-18.1,10.7-26.6,24.3-30.5 c7.3-1.7,15.8-2.3,24.3-2.3v6.8C228.7,409.9,229.3,420,222.5,431.3z"></path> </g> </g></svg>
                <div style="display:flex; flex-direction:column;" ><strong style="font-size: 16px; font-weight: 500; color: #ff9900;">Amazon India</strong>
                <p style="font-size:28px;">${analysis.external_market.amazon_range || 'N/A'}</p></div>
              </div>
              <div style="display: flex; align-items:center; gap:12px; border: 1px solid #eb6d20; line-height: 1; border-radius: 12px; padding: 12px 24px;">
                <svg fill="var(--text)" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 97.75 97.75" xml:space="preserve"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <path d="M48.875,0C21.882,0,0,21.883,0,48.875S21.882,97.75,48.875,97.75S97.75,75.867,97.75,48.875S75.868,0,48.875,0z M78.729,68.146c-0.556,4.598-1.133,9.192-1.649,13.795c-0.19,1.713-0.125,1.703-1.881,1.683 c-13.405-0.167-26.809-0.384-40.214-0.459c-4.803-0.028-9.607,0.289-14.412,0.44c-0.636,0.021-1.271,0.004-2.027,0.004 c0-1.336,0-2.629,0-4.129c1.713-0.338,3.529-0.674,5.334-1.063c0.742-0.16,1.478-0.392,2.181-0.674 c1.061-0.427,1.727-1.216,1.88-2.38c0.071-0.547,0.179-1.096,0.184-1.644c0.092-10.002,0.218-20.003,0.232-30.004 c0.009-6.213-0.15-12.425-0.252-18.636c-0.057-3.517-0.988-4.611-4.417-5.266c-1.457-0.277-2.93-0.497-4.372-0.833 c-0.348-0.083-0.843-0.506-0.871-0.81c-0.104-1.133-0.041-2.279-0.041-3.516c19.228,0.32,38.347,1.13,57.646-0.536 c-0.404,6.527-0.809,13.066-1.221,19.722c-1.169,0-2.239,0.093-3.277-0.049c-0.367-0.052-0.828-0.62-0.955-1.04 c-0.588-1.948-1.023-3.943-1.613-5.892c-0.346-1.132-0.812-2.241-1.346-3.299c-1.207-2.395-3.019-3.681-5.888-3.632 c-6.896,0.121-13.794,0.037-20.69,0.041c-1.754,0.002-1.806,0.06-1.808,1.778c-0.01,7.748-0.016,15.497-0.022,23.244 c-0.002,0.423,0,0.846,0,1.378c3.049,0,5.932,0.048,8.813-0.018c1.867-0.041,3.731-0.225,5.595-0.379 c2.549-0.211,3.455-0.955,4.096-3.415c0.48-1.846,0.91-3.705,1.326-5.567c0.164-0.734,0.498-1.072,1.303-1.015 c1.014,0.072,2.037,0.018,3.199,0.018c0,0.677,0.006,1.284,0,1.894c-0.062,7.271-0.141,14.542-0.164,21.813 c-0.004,0.967-0.228,1.352-1.266,1.357c-3.055,0.022-3.053,0.063-3.773-2.92c-0.26-1.072-0.521-2.146-0.803-3.211 c-0.647-2.455-2.479-3.359-4.783-3.435c-4.335-0.146-8.676-0.188-13.015-0.271c-0.118-0.002-0.237,0.063-0.47,0.125 c-0.021,0.481-0.063,0.979-0.064,1.476c-0.01,6.472-0.016,12.942-0.018,19.413c-0.003,4.021,1.512,5.972,5.546,6.086 c6.204,0.178,12.423,0.049,18.629-0.141c3.754-0.113,6.325-2.312,7.935-5.58c1.312-2.666,2.512-5.392,3.621-8.146 c0.49-1.221,1.129-1.787,2.451-1.584c0.573,0.09,1.174,0.015,1.98,0.015C79.141,64.745,78.934,66.445,78.729,68.146z"></path> </g> </g></svg>
                <div style="display:flex; flex-direction:column;" ><strong style="font-size: 16px; font-weight: 500; color: #eb6d20">Etsy India</strong>
                <p style="font-size:28px;">${analysis.external_market.etsy_range || 'N/A'}</p></div>
              </div>
              <div style="display: flex; align-items:center; gap:12px; border: 1px solid light-dark(#1f74ba, #f8d706); line-height: 1; border-radius: 12px; padding: 12px 24px;">
                <svg fill="var(--text)" viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M3.833 1.333a.993.993 0 0 0-.333.061V1c0-.551.449-1 1-1h14.667c.551 0 1 .449 1 1v.333H3.833zm17.334 2.334H2.833c-.551 0-1 .449-1 1V23c0 .551.449 1 1 1h7.3l1.098-5.645h-2.24c-.051 0-5.158-.241-5.158-.241l4.639-.327-.078-.366-1.978-.285 1.882-.158-.124-.449-3.075-.467s3.341-.373 3.392-.373h3.232l.247-1.331c.289-1.616.945-2.807 1.973-3.693 1.033-.892 2.344-1.332 3.937-1.332.643 0 1.053.151 1.231.463.118.186.201.516.279.859.074.352.14.671.095.903-.057.345-.461.465-1.197.465h-.253c-1.327 0-2.134.763-2.405 2.31l-.243 1.355h1.54c.574 0 .781.402.622 1.306-.17.941-.539 1.36-1.111 1.36H14.9L13.804 24h7.362c.551 0 1-.449 1-1V4.667a1 1 0 0 0-.999-1zM20.5 2.333A.334.334 0 0 0 20.167 2H3.833a.334.334 0 0 0-.333.333V3h17v-.667z"></path></g></svg>
                <div style="display:flex; flex-direction:column;" ><strong style="font-size: 16px; font-weight: 500; color: #f09120">Flipkart</strong>
                <p style="font-size:28px;">${analysis.external_market.flipkart_range || 'N/A'}</p></div>
              </div>
            </div>
            <div style="margin-top: 16px; padding-bottom: 24px; border-bottom: 1px solid var(--border); font-size: 14px; line-height: 1.1;">
              ${analysis.external_market.recommendation || 'Your pricing is competitive with external markets.'}
            </div>
          `;
          document.getElementById('pricing-content').insertBefore(externalDiv, document.querySelector('#similar-products-grid').parentElement);
        }

        // Similar products
        const grid = document.getElementById('similar-products-grid');
        const noProducts = document.getElementById('no-similar-products');

        if (analysis.similar_products.length === 0) {
          grid.style.display = 'none';
          noProducts.style.display = 'block';
        } else {
          grid.style.display = 'grid';
          noProducts.style.display = 'none';

          grid.innerHTML = analysis.similar_products.map(product => `
            <div class="product-card" style="background: var(--bg); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s;">
              ${product.similarity_score ? `<div style="position: absolute; top: 8px; right: 8px; z-index: 1; background: var(--bg); color: var(--text); padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">${product.similarity_score}% match</div>` : ''}
              <div style="position: relative; padding-top: 50%; background: var(--muted);">
                ${product.img_url ? `<img src="${product.img_url}" alt="${product.title}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">` : '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; opacity: 0.3;">ðŸŽ¨</div>'}
              </div>
              <div style="padding: 12px;">
                <div style="font-size: 16px; font-weight: 500; color: var(--text); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${product.title}">${product.title}</div>
                ${product.similarity_reason ? `<div style="font-size: 12px; color: var(--muted); margin-bottom: 6px; line-height: 1.3;">${product.similarity_reason}</div>` : ''}
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                  <div style="font-size: 20px; font-weight: 500; color: var(--accent);">â‚¹${product.price.toFixed(2)}</div>
                  <div style="font-size: 12px; padding: 2px 6px; border-radius: 20em; ${product.price_difference > 0 ? 'background: #ffe0b2; color: #f57c00;' : 'background: #aafff7; color: #005047;'}">
                    ${product.price_difference > 0 ? '+' : ''}${product.price_difference.toFixed(1)}%
                  </div>
                </div>
              </div>
            </div>
          `).join('');

          // Add hover effect via CSS
          document.querySelectorAll('.product-card').forEach(card => {
            card.addEventListener('mouseenter', () => {
              card.style.transform = 'translateY(-4px)';
              card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            });
            card.addEventListener('mouseleave', () => {
              card.style.transform = 'translateY(0)';
              card.style.boxShadow = 'none';
            });
          });
        }
      }
    </script>
    
  </body>
</html>

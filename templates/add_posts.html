<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clyst - Create Post</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    /><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/styles.css">
    <link rel="stylesheet" href="../static/css/add.css">
  </head>
  <body>
    <!-- ===== NAVBAR ===== -->
    <nav id="topNav">
      <div class="nav">
              <div class="nav-left">
        <div class="hamburger" onclick="toggleMenu(event)">
         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4H21V6H3V4ZM3 11H21V13H3V11ZM3 18H21V20H3V18Z"></path></svg>
        </div>
        <a href="{{ url_for('home') }}">Clyst</a>
      </div>

      <div class="nav-center" id="navLinks">
        <a href="{{ url_for('home') }}">Community Feed</a>
        <a href="{{ url_for('products_page') }}">Marketplace</a>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
        <a href="{{ url_for('login') }}">Login</a>
        <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
      </div>

      <div class="nav-actions">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('profile') }}" class="profile-btn" title="Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"
            />
          </svg>
        </a>
        {% endif %}
      </div>
      </div>
    <div class="mobile-menu" id="mobileMenu">
      <a href="{{ url_for('home') }}">Community Feed</a>
      <a href="{{ url_for('products_page') }}">Marketplace</a>
      {% if current_user.is_authenticated %}
      <a href="{{ url_for('logout') }}">Logout</a>
      {% else %}
      <a href="{{ url_for('login') }}">Login</a>
      <a href="{{ url_for('register') }}">Register</a>
      {% endif %}
    </div>
    </nav>

    <div class="container">
      <!-- Main Content -->

      <div class="main-content">
        <div class="form-container">
          <div class="form-card">
            <div class="form-header">
              <h1>Create New Post</h1>
              <p>Share your artwork with the community</p>
            </div>
            <form
              action="{{ url_for('add_posts') }}"
              method="POST"
              enctype="multipart/form-data"
            >
              <div class="form-group">
                <label for="post_title" class="form-label"> Post Title </label>
                <input
                  type="text"
                  id="post_title"
                  name="post_title"
                  class="form-input"
                  placeholder="Enter a catchy title for your post..."
                  required
                />
                <div class="form-help">Make it engaging and descriptive</div>
              </div>

              <div class="form-group">
                <label for="description" class="form-label">
                  Description
                </label>
                <textarea
                  id="description"
                  name="description"
                  class="form-textarea"
                  placeholder="Tell us about your artwork, inspiration, techniques used..."
                  required
                ></textarea>
                <div class="form-help">
                  Share the story behind your creation
                </div>
              </div>

              <div class="form-group">
                <label for="post_image" class="form-label"> Image URL </label>
                <input
                  type="url"
                  id="post_image"
                  name="post_image"
                  class="form-input"
                  placeholder="https://example.com/your-image.jpg"
                />
                <div class="form-help">
                  Add a direct link to your artwork image
                </div>
              </div>

              <div class="form-group">
                <label for="post_image_file" class="form-label">
                  Upload Image
                </label>
                <input
                  type="file"
                  id="post_image_file"
                  name="post_image_file"
                  class="form-input"
                  accept="image/*"
                />
                <div class="form-help">
                  Upload an image from your device (JPG, PNG, GIF, WebP)
                </div>
              </div>

              <div class="form-group prompt-group">
                <label class="form-label">Generate with AI</label>
                <input
                  type="text"
                  id="ai_prompt"
                  class="form-input"
                  placeholder="Optional prompt to guide AI (e.g., style, theme)"
                />
                <button onclick="getPrompt()" class="mic">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.9998 1C14.7612 1 16.9998 3.23858 16.9998 6V10C16.9998 12.7614 14.7612 15 11.9998 15C9.23833 15 6.99976 12.7614 6.99976 10V6C6.99976 3.23858 9.23833 1 11.9998 1ZM3.05469 11H5.07065C5.55588 14.3923 8.47329 17 11.9998 17C15.5262 17 18.4436 14.3923 18.9289 11H20.9448C20.4837 15.1716 17.1714 18.4839 12.9998 18.9451V23H10.9998V18.9451C6.82814 18.4839 3.51584 15.1716 3.05469 11Z"></path></svg>
                </button>
                <div class="form-actions form-actions-ai">
                  <button
                    type="button"
                    id="generate_ai"
                    class="btn btn-secondary"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.0007 1.20825 18.3195 3.68108 20.7923 4.99992 18.3195 6.31876 17.0007 8.79159 15.6818 6.31876 13.209 4.99992 15.6818 3.68108 17.0007 1.20825ZM8.00065 4.33325 10.6673 9.33325 15.6673 11.9999 10.6673 14.6666 8.00065 19.6666 5.33398 14.6666.333984 11.9999 5.33398 9.33325 8.00065 4.33325ZM19.6673 16.3333 18.0007 13.2083 16.334 16.3333 13.209 17.9999 16.334 19.6666 18.0007 22.7916 19.6673 19.6666 22.7923 17.9999 19.6673 16.3333Z"></path></svg> Generate Suggestions
                  </button>
                </div>
                <div id="ai_suggestions" class="ai-suggestions"></div>
              </div>

              <div class="form-actions">
                <a href="{{ url_for('home') }}" class="btn btn-secondary cancel-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.9997 10.5865L16.9495 5.63672L18.3637 7.05093L13.4139 12.0007L18.3637 16.9504L16.9495 18.3646L11.9997 13.4149L7.04996 18.3646L5.63574 16.9504L10.5855 12.0007L5.63574 7.05093L7.04996 5.63672L11.9997 10.5865Z"></path></svg>
                  Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                  Post Artwork
                </button>
              </div>
            </form>
    <script>
    function toggleMenu(e) {
                e?.stopPropagation?.();
                const menu = document.getElementById("mobileMenu");
                const now = menu.style.display === "flex" ? "none" : "flex";
                menu.style.display = now;
                if (now === "flex")
                  document.getElementById("searchBelow").classList.remove("open");
              }

              function hasImageSelected() {
                const url = document.getElementById("post_image").value.trim();
                const file =
                  document.getElementById("post_image_file").files[0];
                return (url && url.length > 0) || !!file;
              }

              // Debug file upload
              document
                .getElementById("post_image_file")
                .addEventListener("change", function (e) {
                  console.log("File selected:", e.target.files[0]);
                  if (e.target.files[0]) {
                    console.log("File name:", e.target.files[0].name);
                    console.log("File size:", e.target.files[0].size);
                    console.log("File type:", e.target.files[0].type);
                  }
                });

              // Enforce image presence & debug form submission
              document
                .querySelector("form")
                .addEventListener("submit", function (e) {
                  console.log("Form submitting...");
                  if (!hasImageSelected()) {
                    e.preventDefault();
                    alert(
                      "Please provide an image URL or upload an image before submitting."
                    );
                    return;
                  }
                  const fileInput = document.getElementById("post_image_file");
                  if (fileInput.files[0]) {
                    console.log(
                      "File being submitted:",
                      fileInput.files[0].name
                    );
                  } else {
                    console.log("No file selected");
                  }
                });

              // AI generation logic
              document
                .getElementById("generate_ai")
                .addEventListener("click", async function () {
                  if (!hasImageSelected()) {
                    alert(
                      "Please provide an image URL or upload an image to generate suggestions."
                    );
                    return;
                  }

                  const suggestionsDiv =
                    document.getElementById("ai_suggestions");
                  suggestionsDiv.innerHTML = "Generating suggestions...";

                  const imageUrl = document
                    .getElementById("post_image")
                    .value.trim();
                  let payload = {
                    type: "post",
                    prompt: document.getElementById("ai_prompt").value.trim(),
                    description: document
                      .getElementById("description")
                      .value.trim(),
                    image_url: imageUrl,
                  };

                  // If file selected, we can still send only URL context for now. Server stub doesn't accept multipart.
                  // Now: also send base64 if a local file is selected.
                  const file =
                    document.getElementById("post_image_file").files[0];
                  if (!imageUrl && file) {
                    const b64 = await new Promise((resolve, reject) => {
                      const reader = new FileReader();
                      reader.onload = () =>
                        resolve(reader.result.split(",")[1]);
                      reader.onerror = reject;
                      reader.readAsDataURL(file);
                    });
                    payload.image_base64 = b64;
                    payload.image_mime = file.type || "image/jpeg";
                  }

                  try {
                    const res = await fetch("/api/generate_copy", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify(payload),
                    });
                    const data = await res.json();
                    if (!data.ok) {
                      suggestionsDiv.innerHTML = `<div style="color:#c62828;">${
                        data.error || "Failed to generate suggestions"
                      }</div>`;
                      return;
                    }
                    const items = data.suggestions || [];
                    suggestionsDiv.innerHTML = items
                      .map(
                        (s, idx) => `
                    <div style="border: 1px solid light-dark(#ddd, #222); background: var(--bg); border-radius: 2px; padding:12px; margin-bottom:8px;">
                      <div style="font-weight:300;color: #8e8e8e">Suggestion ${
                        idx + 1
                      }</div>
                      <div style="font-weight:600; text-transform:uppercase;">${
                        s.title
                      }</div>
                      <div style="margin-bottom:10px; color: var(--text)">${
                        s.description
                      }</div>
                      <button type="button" class="btn btn-primary" data-idx="${idx}">Choose</button>
                    </div>
                  `
                      )
                      .join("");

                    // Attach handlers
                    Array.from(
                      suggestionsDiv.querySelectorAll("button[data-idx]")
                    ).forEach((btn) => {
                      btn.addEventListener("click", () => {
                        const i = parseInt(btn.getAttribute("data-idx"));
                        const chosen = items[i];
                        document.getElementById("post_title").value =
                          chosen.title;
                        document.getElementById("description").value =
                          chosen.description;
                      });
                    });
                  } catch (err) {
                    console.error(err);
                    suggestionsDiv.innerHTML = `<div style="color:#c62828;">Error generating suggestions.</div>`;
                  }
                });

              // --- Translation UI (lightweight) ---
              const trWrap = document.createElement("div");
              trWrap.style.marginTop = "16px";
              trWrap.innerHTML = `
                  <div class="form-group">
                    <label class="form-label">Translate title & description</label>
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                      <select id="tr_lang" class="form-input" style="max-width:200px;">
                        <option value="">Select language</option>
                        <option value="en">English (en)</option>
                        <option value="hi">Hindi (hi)</option>
                        <option value="bn">Bengali (bn)</option>
                        <option value="ta">Tamil (ta)</option>
                        <option value="te">Telugu (te)</option>
                        <option value="mr">Marathi (mr)</option>
                        <option value="gu">Gujarati (gu)</option>
                        <option value="kn">Kannada (kn)</option>
                        <option value="ml">Malayalam (ml)</option>
                        <option value="pa">Punjabi (pa)</option>
                        <option value="ur">Urdu (ur)</option>
                        <option value="es">Spanish (es)</option>
                        <option value="fr">French (fr)</option>
                        <option value="de">German (de)</option>
                        <option value="zh">Chinese (zh)</option>
                        <option value="ja">Japanese (ja)</option>
                      </select>
                      <button type="button" id="do_translate" class="btn btn-secondary">Translate</button>
                    </div>
                    <div id="tr_result" class="ai-suggestions"></div>
                  </div>
                `;
              document.querySelector(".form-card").appendChild(trWrap);

              document
                .getElementById("do_translate")
                .addEventListener("click", async function () {
                  const lang = document.getElementById("tr_lang").value.trim();
                  const title = document
                    .getElementById("post_title")
                    .value.trim();
                  const desc = document
                    .getElementById("description")
                    .value.trim();
                  if (!lang) {
                    alert("Choose a language");
                    return;
                  }
                  if (!(title || desc)) {
                    alert("Fill title or description first");
                    return;
                  }
                  const resBox = document.getElementById("tr_result");
                  resBox.innerHTML = "Translating...";
                  try {
                    const res = await fetch("/api/translate_listing", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({
                        type: "post",
                        title,
                        description: desc,
                        target_lang: lang,
                      }),
                    });
                    const data = await res.json();
                    if (!data.ok) {
                      resBox.innerHTML = `<div style="color:#c62828;">${
                        data.error || "Failed to translate"
                      }</div>`;
                      return;
                    }
                    const phrases = (data.seo_phrases || [])
                      .map(
                        (p) =>
                          `<span style="display:inline-block; margin:4px; padding:4px 8px; border:1px solid #e1e1e1; border-radius:12px; font-size:12px; color:#444;">${p}</span>`
                      )
                      .join("");
                    resBox.innerHTML = `
                      <div style="border:1px solid #e9ecef; border-radius:8px; padding:12px; margin-top:8px;">
                        <div style="font-weight:600; margin-bottom:6px;">Translated</div>
                        <div style="margin-bottom:6px;">Title: ${
                          data.title || ""
                        }</div>
                        <div style="margin-bottom:10px;">Description: ${
                          data.description || ""
                        }</div>
                        <div style="margin-bottom:6px; font-weight:600;">SEO phrases</div>
                        <div>${
                          phrases || '<i style="color:#888;">None</i>'
                        }</div>
                        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                          <button type="button" class="btn btn-primary" id="tr_apply">Apply</button>
                        </div>
                      </div>`;
                    const applyBtn = document.getElementById("tr_apply");
                    applyBtn?.addEventListener("click", () => {
                      document.getElementById("post_title").value =
                        data.title || title;
                      document.getElementById("description").value =
                        data.description || desc;
                    });
                  } catch (err) {
                    console.error(err);
                    resBox.innerHTML = `<div style="color:#c62828;">Error translating.</div>`;
                  }
                });
    </script>

          </div>
        </div>
      </div>
    </div>

    <div id="google_translate_element" class="translate-element"></div>
    <button
      id="translateButton"
      onclick="googleTranslateElementInit()"
      class="translate-btn"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18.5 10L22.9 21H20.745L19.544 18H15.454L14.255 21H12.101L16.5 10H18.5ZM10 2V4H16V6L14.0322 6.0006C13.2425 8.36616 11.9988 10.5057 10.4115 12.301C11.1344 12.9457 11.917 13.5176 12.7475 14.0079L11.9969 15.8855C10.9237 15.2781 9.91944 14.5524 8.99961 13.7249C7.21403 15.332 5.10914 16.5553 2.79891 17.2734L2.26257 15.3442C4.2385 14.7203 6.04543 13.6737 7.59042 12.3021C6.46277 11.0281 5.50873 9.57985 4.76742 8.00028L7.00684 8.00037C7.57018 9.03885 8.23979 10.0033 8.99967 10.877C10.2283 9.46508 11.2205 7.81616 11.9095 6.00101L2 6V4H8V2H10ZM17.5 12.8852L16.253 16H18.745L17.5 12.8852Z"></path></svg>
    </button>

    <script
      type="text/javascript"
      src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"
    ></script>
    <script type="text/javascript">
      function googleTranslateElementInit() {
        new google.translate.TranslateElement(
          {
            pageLanguage: "en", // Set your website's default language
            includedLanguages:
              "en,hi,bi,ta,te,mr,gu,kn,ml,pa,ur,es,fr,de,zh,ja,ko", // Optional: Specify languages to include in the dropdown
            layout: google.translate.TranslateElement.InlineLayout.SIMPLE, // Optional: Customize widget layout
          },
          "google_translate_element"
        );
      }

      function getPrompt(){
        alert("Voice mode still in development. Please use text input for now.");
      }
    </script>
  </body>
</html>

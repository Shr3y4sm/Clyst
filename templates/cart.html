<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clyst - Shopping Cart</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../static/css/styles.css" />
    <link rel="stylesheet" href="../static/css/cart.css" />
    <link rel="stylesheet" href="../static/css/shop-cart.css" />
  </head>
  <body>
    <!-- ===== NAVBAR ===== -->
    <nav id="topNav">
      <div class="nav">
        <div class="nav-left">
          <div class="hamburger" onclick="toggleMenu(event)">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path d="M3 4H21V6H3V4ZM3 11H21V13H3V11ZM3 18H21V20H3V18Z"></path>
            </svg>
          </div>
          <a href="{{ url_for('home') }}">Clyst</a>
        </div>

        <div class="nav-center" id="navLinks">
          <a href="{{ url_for('home') }}">Community Feed</a>
          <a href="{{ url_for('products_page') }}">Marketplace</a>
          {% if current_user.is_authenticated %}
          <a href="{{ url_for('logout') }}">Logout</a>
          {% else %}
          <a href="{{ url_for('login') }}">Login</a>
          <a href="{{ url_for('register') }}">Register</a>
          {% endif %}
        </div>

        <div class="nav-actions">
          {% if current_user.is_authenticated %}
          <a
            href="{{ url_for('view_cart') }}"
            class="cart-btn"
            title="Shopping Cart"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M4.00436 6.41686L0.761719 3.17422L2.17593 1.76001L5.41857 5.00265H20.6603C21.2126 5.00265 21.6603 5.45037 21.6603 6.00265C21.6603 6.09997 21.6461 6.19678 21.6182 6.29L19.2182 14.29C19.0913 14.713 18.7019 15.0027 18.2603 15.0027H6.00436V17.0027H17.0044V19.0027H5.00436C4.45207 19.0027 4.00436 18.5549 4.00436 18.0027V6.41686ZM5.50436 23.0027C4.67593 23.0027 4.00436 22.3311 4.00436 21.5027C4.00436 20.6742 4.67593 20.0027 5.50436 20.0027C6.33279 20.0027 7.00436 20.6742 7.00436 21.5027C7.00436 22.3311 6.33279 23.0027 5.50436 23.0027ZM17.5044 23.0027C16.6759 23.0027 16.0044 22.3311 16.0044 21.5027C16.0044 20.6742 16.6759 20.0027 17.5044 20.0027C18.3328 20.0027 19.0044 20.6742 19.0044 21.5027C19.0044 22.3311 18.3328 23.0027 17.5044 23.0027Z"
              ></path>
            </svg>
            <span class="cart-count" id="cartCount">0</span>
          </a>
          <a
            href="{{ url_for('profile') }}"
            class="profile-btn"
            title="Profile"
          >
           <svg width="100%" height="100%" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M28.8662 27.5C28.7784 27.652 28.6521 27.7783 28.5001 27.8661C28.348 27.9538 28.1755 28 28 28H3.99995C3.8245 27.9998 3.65219 27.9535 3.50031 27.8656C3.34843 27.7778 3.22234 27.6515 3.13469 27.4995C3.04705 27.3475 3.00093 27.1752 3.00098 26.9997C3.00102 26.8243 3.04723 26.6519 3.13495 26.5C5.0387 23.2087 7.97245 20.8487 11.3962 19.73C9.70266 18.7218 8.38688 17.1856 7.65094 15.3572C6.91499 13.5289 6.79956 11.5095 7.32238 9.60918C7.8452 7.70887 8.97735 6.03272 10.545 4.83814C12.1126 3.64355 14.029 2.99658 16 2.99658C17.9709 2.99658 19.8873 3.64355 21.4549 4.83814C23.0226 6.03272 24.1547 7.70887 24.6775 9.60918C25.2003 11.5095 25.0849 13.5289 24.349 15.3572C23.613 17.1856 22.2972 18.7218 20.6037 19.73C24.0275 20.8487 26.9612 23.2087 28.865 26.5C28.9529 26.6519 28.9993 26.8243 28.9996 26.9998C28.9998 27.1754 28.9538 27.3479 28.8662 27.5Z" fill="inherit"/></svg>
        </a>
          {% endif %}
        </div>
      </div>

      <div class="mobile-menu" id="mobileMenu">
        <a href="{{ url_for('home') }}">Community Feed</a>
        <a href="{{ url_for('products_page') }}">Marketplace</a>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('view_cart') }}">Shopping Cart</a>
        <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
        <a href="{{ url_for('login') }}">Login</a>
        <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
      </div>
    </nav>

    <div class="container">
      <div class="header">
        <h1>Shopping Cart</h1>
      </div>

      <div class="main-content">
        {% if cart_items %}

        <div class="cart-summary">
          <div class="summary-card">
            <h3 class="cart-header">Your Order Summary 
                <button
                  class="btn btn-secondary btn-danger"
                  onclick="clearCart()"
                >
                  Clear Cart
                </button></h3>
            <div class="cart-container">
              <div class="cart-items">
                {% for item in cart_items %}
                <div class="cart-item" data-item-id="{{ item.item_id }}">
                  <div class="item-info">
                    <div class="detail-of-item">
                  <div class="item-image">
                    {% if item.product.img_url %}
                    <img
                      src="{{ item.product.img_url }}"
                      alt="{{ item.product.title }}"
                    />
                    {% else %}
                    <div class="placeholder-image">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                      >
                        <path
                          d="M20 5H4V19L13.2923 9.70649C13.6828 9.31595 14.3159 9.31591 14.7065 9.70641L20 15.0104V5ZM2 3.9934C2 3.44476 2.45531 3 2.9918 3H21.0082C21.556 3 22 3.44495 22 3.9934V20.0066C22 20.5552 21.5447 21 21.0082 21H2.9918C2.44405 21 2 20.5551 2 20.0066V3.9934ZM8 11C6.89543 11 6 10.1046 6 9C6 7.89543 6.89543 7 8 7C9.10457 7 10 7.89543 10 9C10 10.1046 9.10457 11 8 11Z"
                        ></path>
                      </svg>
                    </div>
                    {% endif %}
                  </div>
                    <div class="item-details">
                      <h3 class="item-title">{{ item.product.title }}</h3>
                      <p class="item-artist">
                        By {{ item.product.artist.name }}
                      </p>
                      <label for="item-price">Price</label>
                      <p class="item-price">Rs.{{ item.product.price }}</p>
                    </div></div>

                    <div class="item-quantity">
                      <label for="quantity-{{ item.item_id }}">Quantity</label>
                      <div class="quantity-controls">
                        <button
                          class="quantity-btn left"
                          onclick="updateQuantity('{{ item.item_id }}', {{ item.quantity|int - 1 }})"
                          type="button"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                          >
                            <path d="M19 11H5V13H19V11Z"></path>
                          </svg>
                        </button>
                        <input
                          type="number"
                          id="quantity-{{ item.item_id }}"
                          value="{{ item.quantity }}"
                          min="1"
                          onchange="updateQuantity('{{ item.item_id }}', this.value)"
                        />
                        <button
                          class="quantity-btn right"
                          onclick="updateQuantity('{{ item.item_id }}', {{ item.quantity|int + 1 }})"
                          type="button"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                          >
                            <path
                              d="M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"
                            ></path>
                          </svg>
                        </button>
                      </div>
                      <label for="total-price">Item total</label>
                      <span class="total-price"
                        >Rs. {{ "%.2f"|format(item.quantity *
                        item.product.price) }}</span
                      >
                    </div>
                    
                      <button
                        class="btn btn-remove btn-secondary"
                        onclick="removeItem('{{ item.item_id }}')"
                        title="Remove item"
                        type="button"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.9997 10.5865L16.9495 5.63672L18.3637 7.05093L13.4139 12.0007L18.3637 16.9504L16.9495 18.3646L11.9997 13.4149L7.04996 18.3646L5.63574 16.9504L10.5855 12.0007L5.63574 7.05093L7.04996 5.63672L11.9997 10.5865Z"></path></svg>
                      </button>
                  </div>
                </div>
                {% endfor %}
              </div>
              <div class="summary-row">
                <span class="summary-label"
                  >Subtotal ({{ cart_items|length }} items)</span
                >
                <span>Rs. {{ "%.2f"|format(total_price) }}</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">Shipping</span>
                <span>Free</span>
              </div>
              <div class="summary-row total">
                <span class="summary-label">TOTAL</span>
                <span>Rs. {{ "%.2f"|format(total_price) }}</span>
              </div>

              <div class="checkout-actions">
                <button class="btn btn-secondary" onclick="continueShopping()">
                  Continue Shopping
                </button>
                <button
                  class="btn btn-primary checkout-btn"
                  onclick="proceedToCheckout()"
                >
                  Checkout to pay
                </button>
              </div>
            </div>
          </div>
        </div>
        {% else %}
        <div class="empty-cart">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M4.00436 6.41686L0.761719 3.17422L2.17593 1.76001L5.41857 5.00265H20.6603C21.2126 5.00265 21.6603 5.45037 21.6603 6.00265C21.6603 6.09997 21.6461 6.19678 21.6182 6.29L19.2182 14.29C19.0913 14.713 18.7019 15.0027 18.2603 15.0027H6.00436V17.0027H17.0044V19.0027H5.00436C4.45207 19.0027 4.00436 18.5549 4.00436 18.0027V6.41686ZM6.00436 7.00265V13.0027H17.5163L19.3163 7.00265H6.00436ZM5.50436 23.0027C4.67593 23.0027 4.00436 22.3311 4.00436 21.5027C4.00436 20.6742 4.67593 20.0027 5.50436 20.0027C6.33279 20.0027 7.00436 20.6742 7.00436 21.5027C7.00436 22.3311 6.33279 23.0027 5.50436 23.0027ZM17.5044 23.0027C16.6759 23.0027 16.0044 22.3311 16.0044 21.5027C16.0044 20.6742 16.6759 20.0027 17.5044 20.0027C18.3328 20.0027 19.0044 20.6742 19.0044 21.5027C19.0044 22.3311 18.3328 23.0027 17.5044 23.0027Z"
            ></path>
          </svg>
          <h3>Your cart is empty</h3>
          <p>Looks like you haven't added any items to your cart yet.</p>
          <a href="{{ url_for('products_page') }}" class="btn btn-primary">
            Start Shopping
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    <div id="google_translate_element" class="translate-element"></div>
    <button
      id="translateButton"
      onclick="googleTranslateElementInit()"
      class="translate-btn"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
      >
        <path
          d="M18.5 10L22.9 21H20.745L19.544 18H15.454L14.255 21H12.101L16.5 10H18.5ZM10 2V4H16V6L14.0322 6.0006C13.2425 8.36616 11.9988 10.5057 10.4115 12.301C11.1344 12.9457 11.917 13.5176 12.7475 14.0079L11.9969 15.8855C10.9237 15.2781 9.91944 14.5524 8.99961 13.7249C7.21403 15.332 5.10914 16.5553 2.79891 17.2734L2.26257 15.3442C4.2385 14.7203 6.04543 13.6737 7.59042 12.3021C6.46277 11.0281 5.50873 9.57985 4.76742 8.00028L7.00684 8.00037C7.57018 9.03885 8.23979 10.0033 8.99967 10.877C10.2283 9.46508 11.2205 7.81616 11.9095 6.00101L2 6V4H8V2H10ZM17.5 12.8852L16.253 16H18.745L17.5 12.8852Z"
        />
      </svg>
    </button>

    <script>
      function toggleMenu(e) {
        e?.stopPropagation?.();
        const menu = document.getElementById("mobileMenu");
        const now = menu.style.display === "flex" ? "none" : "flex";
        menu.style.display = now;
        if (now === "flex")
          document.getElementById("searchBelow").classList.remove("open");
      }

      // Update cart count on page load
      document.addEventListener("DOMContentLoaded", function () {
        updateCartCount();
      });

      async function updateCartCount() {
        try {
          const response = await fetch("/api/cart/count");
          const data = await response.json();
          document.getElementById("cartCount").textContent = data.count;
        } catch (error) {
          console.error("Error updating cart count:", error);
        }
      }

      async function updateQuantity(itemId, newQuantity) {
        if (newQuantity < 1) {
          removeItem(itemId);
          return;
        }

        try {
          const response = await fetch(`/cart/update/${itemId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ quantity: parseInt(newQuantity) }),
          });

          const data = await response.json();
          if (data.success) {
            location.reload(); // Refresh to update totals
          } else {
            alert("Error updating quantity");
          }
        } catch (error) {
          console.error("Error updating quantity:", error);
          alert("Error updating quantity");
        }
      }

      async function removeItem(itemId) {
        if (!confirm("Remove this item from cart?")) return;

        try {
          const response = await fetch(`/cart/remove/${itemId}`, {
            method: "POST",
          });

          const data = await response.json();
          if (data.success) {
            location.reload();
          } else {
            alert("Error removing item");
          }
        } catch (error) {
          console.error("Error removing item:", error);
          alert("Error removing item");
        }
      }

      async function clearCart() {
        if (!confirm("Clear entire cart? This action cannot be undone."))
          return;

        try {
          const response = await fetch("/cart/clear", {
            method: "POST",
          });

          const data = await response.json();
          if (data.success) {
            location.reload();
          } else {
            alert("Error clearing cart");
          }
        } catch (error) {
          console.error("Error clearing cart:", error);
          alert("Error clearing cart");
        }
      }

      function proceedToCheckout() {
        window.location.href = "{{ url_for('checkout') }}";
      }

      function continueShopping() {
        window.location.href = "{{ url_for('products_page') }}";
      }

      // Search functionality
      document.addEventListener("DOMContentLoaded", function () {
        const global = document.getElementById("globalSearchInput");
        if (global) {
          global.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              const q = global.value.trim();
              const url = new URL(window.location.origin + "/products");
              if (q) url.searchParams.set("q", q);
              window.location.href = url.toString();
            }
          });
        }
      });
    </script>

    <script
      type="text/javascript"
      src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"
    ></script>
    <script type="text/javascript">
      function googleTranslateElementInit() {
        new google.translate.TranslateElement(
          {
            pageLanguage: "en",
            includedLanguages:
              "en,hi,bi,ta,te,mr,gu,kn,ml,pa,ur,es,fr,de,zh,ja,ko",
            layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
          },
          "google_translate_element"
        );
      }
    </script>
  </body>
</html>
